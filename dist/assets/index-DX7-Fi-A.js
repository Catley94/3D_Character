(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();function g(t,e,n,i){if(typeof e=="function"?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?i:n==="a"?i.call(t):i?i.value:e.get(t)}function V(t,e,n,i,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n}var P,_,W,fe,pe;const m="__TAURI_TO_IPC_KEY__";function ft(t,e=!1){return window.__TAURI_INTERNALS__.transformCallback(t,e)}class Ht{constructor(e){P.set(this,void 0),_.set(this,0),W.set(this,[]),fe.set(this,void 0),V(this,P,e||(()=>{})),this.id=ft(n=>{const i=n.index;if("end"in n){i==g(this,_,"f")?this.cleanupCallback():V(this,fe,i);return}const s=n.message;if(i==g(this,_,"f")){for(g(this,P,"f").call(this,s),V(this,_,g(this,_,"f")+1);g(this,_,"f")in g(this,W,"f");){const o=g(this,W,"f")[g(this,_,"f")];g(this,P,"f").call(this,o),delete g(this,W,"f")[g(this,_,"f")],V(this,_,g(this,_,"f")+1)}g(this,_,"f")===g(this,fe,"f")&&this.cleanupCallback()}else g(this,W,"f")[i]=s})}cleanupCallback(){window.__TAURI_INTERNALS__.unregisterCallback(this.id)}set onmessage(e){V(this,P,e)}get onmessage(){return g(this,P,"f")}[(P=new WeakMap,_=new WeakMap,W=new WeakMap,fe=new WeakMap,m)](){return`__CHANNEL__:${this.id}`}toJSON(){return this[m]()}}async function a(t,e={},n){return window.__TAURI_INTERNALS__.invoke(t,e,n)}class Ut{get rid(){return g(this,pe,"f")}constructor(e){pe.set(this,void 0),V(this,pe,e)}async close(){return a("plugin:resources|close",{rid:this.rid})}}pe=new WeakMap;class de{constructor(...e){this.type="Logical",e.length===1?"Logical"in e[0]?(this.width=e[0].Logical.width,this.height=e[0].Logical.height):(this.width=e[0].width,this.height=e[0].height):(this.width=e[0],this.height=e[1])}toPhysical(e){return new x(this.width*e,this.height*e)}[m](){return{width:this.width,height:this.height}}toJSON(){return this[m]()}}class x{constructor(...e){this.type="Physical",e.length===1?"Physical"in e[0]?(this.width=e[0].Physical.width,this.height=e[0].Physical.height):(this.width=e[0].width,this.height=e[0].height):(this.width=e[0],this.height=e[1])}toLogical(e){return new de(this.width/e,this.height/e)}[m](){return{width:this.width,height:this.height}}toJSON(){return this[m]()}}class H{constructor(e){this.size=e}toLogical(e){return this.size instanceof de?this.size:this.size.toLogical(e)}toPhysical(e){return this.size instanceof x?this.size:this.size.toPhysical(e)}[m](){return{[`${this.size.type}`]:{width:this.size.width,height:this.size.height}}}toJSON(){return this[m]()}}class yt{constructor(...e){this.type="Logical",e.length===1?"Logical"in e[0]?(this.x=e[0].Logical.x,this.y=e[0].Logical.y):(this.x=e[0].x,this.y=e[0].y):(this.x=e[0],this.y=e[1])}toPhysical(e){return new C(this.x*e,this.y*e)}[m](){return{x:this.x,y:this.y}}toJSON(){return this[m]()}}class C{constructor(...e){this.type="Physical",e.length===1?"Physical"in e[0]?(this.x=e[0].Physical.x,this.y=e[0].Physical.y):(this.x=e[0].x,this.y=e[0].y):(this.x=e[0],this.y=e[1])}toLogical(e){return new yt(this.x/e,this.y/e)}[m](){return{x:this.x,y:this.y}}toJSON(){return this[m]()}}class ye{constructor(e){this.position=e}toLogical(e){return this.position instanceof yt?this.position:this.position.toLogical(e)}toPhysical(e){return this.position instanceof C?this.position:this.position.toPhysical(e)}[m](){return{[`${this.position.type}`]:{x:this.position.x,y:this.position.y}}}toJSON(){return this[m]()}}var b;(function(t){t.WINDOW_RESIZED="tauri://resize",t.WINDOW_MOVED="tauri://move",t.WINDOW_CLOSE_REQUESTED="tauri://close-requested",t.WINDOW_DESTROYED="tauri://destroyed",t.WINDOW_FOCUS="tauri://focus",t.WINDOW_BLUR="tauri://blur",t.WINDOW_SCALE_FACTOR_CHANGED="tauri://scale-change",t.WINDOW_THEME_CHANGED="tauri://theme-changed",t.WINDOW_CREATED="tauri://window-created",t.WEBVIEW_CREATED="tauri://webview-created",t.DRAG_ENTER="tauri://drag-enter",t.DRAG_OVER="tauri://drag-over",t.DRAG_DROP="tauri://drag-drop",t.DRAG_LEAVE="tauri://drag-leave"})(b||(b={}));async function pt(t,e){window.__TAURI_EVENT_PLUGIN_INTERNALS__.unregisterListener(t,e),await a("plugin:event|unlisten",{event:t,eventId:e})}async function ae(t,e,n){var i;const s=typeof(n==null?void 0:n.target)=="string"?{kind:"AnyLabel",label:n.target}:(i=n==null?void 0:n.target)!==null&&i!==void 0?i:{kind:"Any"};return a("plugin:event|listen",{event:t,target:s,handler:ft(e)}).then(o=>async()=>pt(t,o))}async function zt(t,e,n){return ae(t,i=>{pt(t,i.id),e(i)},n)}async function Kt(t,e){await a("plugin:event|emit",{event:t,payload:e})}async function Yt(t,e,n){await a("plugin:event|emit_to",{target:typeof t=="string"?{kind:"AnyLabel",label:t}:t,event:e,payload:n})}class ie extends Ut{constructor(e){super(e)}static async new(e,n,i){return a("plugin:image|new",{rgba:ve(e),width:n,height:i}).then(s=>new ie(s))}static async fromBytes(e){return a("plugin:image|from_bytes",{bytes:ve(e)}).then(n=>new ie(n))}static async fromPath(e){return a("plugin:image|from_path",{path:e}).then(n=>new ie(n))}async rgba(){return a("plugin:image|rgba",{rid:this.rid}).then(e=>new Uint8Array(e))}async size(){return a("plugin:image|size",{rid:this.rid})}}function ve(t){return t==null?null:typeof t=="string"?t:t instanceof ie?t.rid:t}var Ae;(function(t){t[t.Critical=1]="Critical",t[t.Informational=2]="Informational"})(Ae||(Ae={}));class jt{constructor(e){this._preventDefault=!1,this.event=e.event,this.id=e.id}preventDefault(){this._preventDefault=!0}isPreventDefault(){return this._preventDefault}}var Ge;(function(t){t.None="none",t.Normal="normal",t.Indeterminate="indeterminate",t.Paused="paused",t.Error="error"})(Ge||(Ge={}));function N(){return new wt(window.__TAURI_INTERNALS__.metadata.currentWindow.label,{skip:!0})}async function Re(){return a("plugin:window|get_all_windows").then(t=>t.map(e=>new wt(e,{skip:!0})))}const Oe=["tauri://created","tauri://error"];class wt{constructor(e,n={}){var i;this.label=e,this.listeners=Object.create(null),n!=null&&n.skip||a("plugin:window|create",{options:{...n,parent:typeof n.parent=="string"?n.parent:(i=n.parent)===null||i===void 0?void 0:i.label,label:e}}).then(async()=>this.emit("tauri://created")).catch(async s=>this.emit("tauri://error",s))}static async getByLabel(e){var n;return(n=(await Re()).find(i=>i.label===e))!==null&&n!==void 0?n:null}static getCurrent(){return N()}static async getAll(){return Re()}static async getFocusedWindow(){for(const e of await Re())if(await e.isFocused())return e;return null}async listen(e,n){return this._handleTauriEvent(e,n)?()=>{const i=this.listeners[e];i.splice(i.indexOf(n),1)}:ae(e,n,{target:{kind:"Window",label:this.label}})}async once(e,n){return this._handleTauriEvent(e,n)?()=>{const i=this.listeners[e];i.splice(i.indexOf(n),1)}:zt(e,n,{target:{kind:"Window",label:this.label}})}async emit(e,n){if(Oe.includes(e)){for(const i of this.listeners[e]||[])i({event:e,id:-1,payload:n});return}return Kt(e,n)}async emitTo(e,n,i){if(Oe.includes(n)){for(const s of this.listeners[n]||[])s({event:n,id:-1,payload:i});return}return Yt(e,n,i)}_handleTauriEvent(e,n){return Oe.includes(e)?(e in this.listeners?this.listeners[e].push(n):this.listeners[e]=[n],!0):!1}async scaleFactor(){return a("plugin:window|scale_factor",{label:this.label})}async innerPosition(){return a("plugin:window|inner_position",{label:this.label}).then(e=>new C(e))}async outerPosition(){return a("plugin:window|outer_position",{label:this.label}).then(e=>new C(e))}async innerSize(){return a("plugin:window|inner_size",{label:this.label}).then(e=>new x(e))}async outerSize(){return a("plugin:window|outer_size",{label:this.label}).then(e=>new x(e))}async isFullscreen(){return a("plugin:window|is_fullscreen",{label:this.label})}async isMinimized(){return a("plugin:window|is_minimized",{label:this.label})}async isMaximized(){return a("plugin:window|is_maximized",{label:this.label})}async isFocused(){return a("plugin:window|is_focused",{label:this.label})}async isDecorated(){return a("plugin:window|is_decorated",{label:this.label})}async isResizable(){return a("plugin:window|is_resizable",{label:this.label})}async isMaximizable(){return a("plugin:window|is_maximizable",{label:this.label})}async isMinimizable(){return a("plugin:window|is_minimizable",{label:this.label})}async isClosable(){return a("plugin:window|is_closable",{label:this.label})}async isVisible(){return a("plugin:window|is_visible",{label:this.label})}async title(){return a("plugin:window|title",{label:this.label})}async theme(){return a("plugin:window|theme",{label:this.label})}async isAlwaysOnTop(){return a("plugin:window|is_always_on_top",{label:this.label})}async center(){return a("plugin:window|center",{label:this.label})}async requestUserAttention(e){let n=null;return e&&(e===Ae.Critical?n={type:"Critical"}:n={type:"Informational"}),a("plugin:window|request_user_attention",{label:this.label,value:n})}async setResizable(e){return a("plugin:window|set_resizable",{label:this.label,value:e})}async setEnabled(e){return a("plugin:window|set_enabled",{label:this.label,value:e})}async isEnabled(){return a("plugin:window|is_enabled",{label:this.label})}async setMaximizable(e){return a("plugin:window|set_maximizable",{label:this.label,value:e})}async setMinimizable(e){return a("plugin:window|set_minimizable",{label:this.label,value:e})}async setClosable(e){return a("plugin:window|set_closable",{label:this.label,value:e})}async setTitle(e){return a("plugin:window|set_title",{label:this.label,value:e})}async maximize(){return a("plugin:window|maximize",{label:this.label})}async unmaximize(){return a("plugin:window|unmaximize",{label:this.label})}async toggleMaximize(){return a("plugin:window|toggle_maximize",{label:this.label})}async minimize(){return a("plugin:window|minimize",{label:this.label})}async unminimize(){return a("plugin:window|unminimize",{label:this.label})}async show(){return a("plugin:window|show",{label:this.label})}async hide(){return a("plugin:window|hide",{label:this.label})}async close(){return a("plugin:window|close",{label:this.label})}async destroy(){return a("plugin:window|destroy",{label:this.label})}async setDecorations(e){return a("plugin:window|set_decorations",{label:this.label,value:e})}async setShadow(e){return a("plugin:window|set_shadow",{label:this.label,value:e})}async setEffects(e){return a("plugin:window|set_effects",{label:this.label,value:e})}async clearEffects(){return a("plugin:window|set_effects",{label:this.label,value:null})}async setAlwaysOnTop(e){return a("plugin:window|set_always_on_top",{label:this.label,value:e})}async setAlwaysOnBottom(e){return a("plugin:window|set_always_on_bottom",{label:this.label,value:e})}async setContentProtected(e){return a("plugin:window|set_content_protected",{label:this.label,value:e})}async setSize(e){return a("plugin:window|set_size",{label:this.label,value:e instanceof H?e:new H(e)})}async setMinSize(e){return a("plugin:window|set_min_size",{label:this.label,value:e instanceof H?e:e?new H(e):null})}async setMaxSize(e){return a("plugin:window|set_max_size",{label:this.label,value:e instanceof H?e:e?new H(e):null})}async setSizeConstraints(e){function n(i){return i?{Logical:i}:null}return a("plugin:window|set_size_constraints",{label:this.label,value:{minWidth:n(e==null?void 0:e.minWidth),minHeight:n(e==null?void 0:e.minHeight),maxWidth:n(e==null?void 0:e.maxWidth),maxHeight:n(e==null?void 0:e.maxHeight)}})}async setPosition(e){return a("plugin:window|set_position",{label:this.label,value:e instanceof ye?e:new ye(e)})}async setFullscreen(e){return a("plugin:window|set_fullscreen",{label:this.label,value:e})}async setSimpleFullscreen(e){return a("plugin:window|set_simple_fullscreen",{label:this.label,value:e})}async setFocus(){return a("plugin:window|set_focus",{label:this.label})}async setFocusable(e){return a("plugin:window|set_focusable",{label:this.label,value:e})}async setIcon(e){return a("plugin:window|set_icon",{label:this.label,value:ve(e)})}async setSkipTaskbar(e){return a("plugin:window|set_skip_taskbar",{label:this.label,value:e})}async setCursorGrab(e){return a("plugin:window|set_cursor_grab",{label:this.label,value:e})}async setCursorVisible(e){return a("plugin:window|set_cursor_visible",{label:this.label,value:e})}async setCursorIcon(e){return a("plugin:window|set_cursor_icon",{label:this.label,value:e})}async setBackgroundColor(e){return a("plugin:window|set_background_color",{color:e})}async setCursorPosition(e){return a("plugin:window|set_cursor_position",{label:this.label,value:e instanceof ye?e:new ye(e)})}async setIgnoreCursorEvents(e){return a("plugin:window|set_ignore_cursor_events",{label:this.label,value:e})}async startDragging(){return a("plugin:window|start_dragging",{label:this.label})}async startResizeDragging(e){return a("plugin:window|start_resize_dragging",{label:this.label,value:e})}async setBadgeCount(e){return a("plugin:window|set_badge_count",{label:this.label,value:e})}async setBadgeLabel(e){return a("plugin:window|set_badge_label",{label:this.label,value:e})}async setOverlayIcon(e){return a("plugin:window|set_overlay_icon",{label:this.label,value:e?ve(e):void 0})}async setProgressBar(e){return a("plugin:window|set_progress_bar",{label:this.label,value:e})}async setVisibleOnAllWorkspaces(e){return a("plugin:window|set_visible_on_all_workspaces",{label:this.label,value:e})}async setTitleBarStyle(e){return a("plugin:window|set_title_bar_style",{label:this.label,value:e})}async setTheme(e){return a("plugin:window|set_theme",{label:this.label,value:e})}async onResized(e){return this.listen(b.WINDOW_RESIZED,n=>{n.payload=new x(n.payload),e(n)})}async onMoved(e){return this.listen(b.WINDOW_MOVED,n=>{n.payload=new C(n.payload),e(n)})}async onCloseRequested(e){return this.listen(b.WINDOW_CLOSE_REQUESTED,async n=>{const i=new jt(n);await e(i),i.isPreventDefault()||await this.destroy()})}async onDragDropEvent(e){const n=await this.listen(b.DRAG_ENTER,r=>{e({...r,payload:{type:"enter",paths:r.payload.paths,position:new C(r.payload.position)}})}),i=await this.listen(b.DRAG_OVER,r=>{e({...r,payload:{type:"over",position:new C(r.payload.position)}})}),s=await this.listen(b.DRAG_DROP,r=>{e({...r,payload:{type:"drop",paths:r.payload.paths,position:new C(r.payload.position)}})}),o=await this.listen(b.DRAG_LEAVE,r=>{e({...r,payload:{type:"leave"}})});return()=>{n(),s(),i(),o()}}async onFocusChanged(e){const n=await this.listen(b.WINDOW_FOCUS,s=>{e({...s,payload:!0})}),i=await this.listen(b.WINDOW_BLUR,s=>{e({...s,payload:!1})});return()=>{n(),i()}}async onScaleChanged(e){return this.listen(b.WINDOW_SCALE_FACTOR_CHANGED,e)}async onThemeChanged(e){return this.listen(b.WINDOW_THEME_CHANGED,e)}}var Be;(function(t){t.Disabled="disabled",t.Throttle="throttle",t.Suspend="suspend"})(Be||(Be={}));var Fe;(function(t){t.Default="default",t.FluentOverlay="fluentOverlay"})(Fe||(Fe={}));var We;(function(t){t.AppearanceBased="appearanceBased",t.Light="light",t.Dark="dark",t.MediumLight="mediumLight",t.UltraDark="ultraDark",t.Titlebar="titlebar",t.Selection="selection",t.Menu="menu",t.Popover="popover",t.Sidebar="sidebar",t.HeaderView="headerView",t.Sheet="sheet",t.WindowBackground="windowBackground",t.HudWindow="hudWindow",t.FullScreenUI="fullScreenUI",t.Tooltip="tooltip",t.ContentBackground="contentBackground",t.UnderWindowBackground="underWindowBackground",t.UnderPageBackground="underPageBackground",t.Mica="mica",t.Blur="blur",t.Acrylic="acrylic",t.Tabbed="tabbed",t.TabbedDark="tabbedDark",t.TabbedLight="tabbedLight"})(We||(We={}));var He;(function(t){t.FollowsWindowActiveState="followsWindowActiveState",t.Active="active",t.Inactive="inactive"})(He||(He={}));function Vt(t){return t===null?null:{name:t.name,scaleFactor:t.scaleFactor,position:new C(t.position),size:new x(t.size),workArea:{position:new C(t.workArea.position),size:new x(t.workArea.size)}}}async function mt(){return a("plugin:window|current_monitor").then(Vt)}function qt(){console.log("[Interactions] Standard CSS Hover Mode (Windowed)"),ae("cursor-pos",t=>{const{x:e,y:n}=t.payload;Math.random()<.05&&console.log(`[Interactions] Cursor: ${e}, ${n}`)})}async function _e(t,e){const n=new Ht;return n.onmessage=e,await a("plugin:global-shortcut|register",{shortcuts:Array.isArray(t)?t:[t],handler:n})}async function Ee(t){return await a("plugin:global-shortcut|unregister",{shortcuts:Array.isArray(t)?t:[t]})}async function Jt(){return await a("plugin:global-shortcut|unregister_all",{})}const y={IDLE:"idle",CLICKED:"clicked",LISTENING:"listening",TALKING:"talking"},T={toggleChat:"Super+Shift+F",toggleDrag:"Super+Shift+D",toggleVisibility:"Super+Shift+H",screensaver:"Super+Shift+S"},S={currentState:y.IDLE,config:{shortcuts:T},isTyping:!1,hasDragged:!1,isDragging:!1,isWindowLocked:!1};var Ue;(function(t){t.STRING="string",t.NUMBER="number",t.INTEGER="integer",t.BOOLEAN="boolean",t.ARRAY="array",t.OBJECT="object"})(Ue||(Ue={}));var ze;(function(t){t.LANGUAGE_UNSPECIFIED="language_unspecified",t.PYTHON="python"})(ze||(ze={}));var Ke;(function(t){t.OUTCOME_UNSPECIFIED="outcome_unspecified",t.OUTCOME_OK="outcome_ok",t.OUTCOME_FAILED="outcome_failed",t.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(Ke||(Ke={}));const Ye=["user","model","function","system"];var je;(function(t){t.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",t.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",t.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",t.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",t.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(je||(je={}));var Ve;(function(t){t.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",t.BLOCK_NONE="BLOCK_NONE"})(Ve||(Ve={}));var qe;(function(t){t.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",t.NEGLIGIBLE="NEGLIGIBLE",t.LOW="LOW",t.MEDIUM="MEDIUM",t.HIGH="HIGH"})(qe||(qe={}));var Je;(function(t){t.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",t.SAFETY="SAFETY",t.OTHER="OTHER"})(Je||(Je={}));var se;(function(t){t.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",t.STOP="STOP",t.MAX_TOKENS="MAX_TOKENS",t.SAFETY="SAFETY",t.RECITATION="RECITATION",t.LANGUAGE="LANGUAGE",t.OTHER="OTHER"})(se||(se={}));var Xe;(function(t){t.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",t.RETRIEVAL_QUERY="RETRIEVAL_QUERY",t.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",t.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",t.CLASSIFICATION="CLASSIFICATION",t.CLUSTERING="CLUSTERING"})(Xe||(Xe={}));var Qe;(function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.AUTO="AUTO",t.ANY="ANY",t.NONE="NONE"})(Qe||(Qe={}));var Ze;(function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.MODE_DYNAMIC="MODE_DYNAMIC"})(Ze||(Ze={}));class w extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class U extends w{constructor(e,n){super(e),this.response=n}}class bt extends w{constructor(e,n,i,s){super(e),this.status=n,this.statusText=i,this.errorDetails=s}}class k extends w{}const Xt="https://generativelanguage.googleapis.com",Qt="v1beta",Zt="0.21.0",en="genai-js";var B;(function(t){t.GENERATE_CONTENT="generateContent",t.STREAM_GENERATE_CONTENT="streamGenerateContent",t.COUNT_TOKENS="countTokens",t.EMBED_CONTENT="embedContent",t.BATCH_EMBED_CONTENTS="batchEmbedContents"})(B||(B={}));class tn{constructor(e,n,i,s,o){this.model=e,this.task=n,this.apiKey=i,this.stream=s,this.requestOptions=o}toString(){var e,n;const i=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||Qt;let o=`${((n=this.requestOptions)===null||n===void 0?void 0:n.baseUrl)||Xt}/${i}/${this.model}:${this.task}`;return this.stream&&(o+="?alt=sse"),o}}function nn(t){const e=[];return t!=null&&t.apiClient&&e.push(t.apiClient),e.push(`${en}/${Zt}`),e.join(" ")}async function sn(t){var e;const n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",nn(t.requestOptions)),n.append("x-goog-api-key",t.apiKey);let i=(e=t.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(i){if(!(i instanceof Headers))try{i=new Headers(i)}catch(s){throw new k(`unable to convert customHeaders value ${JSON.stringify(i)} to Headers: ${s.message}`)}for(const[s,o]of i.entries()){if(s==="x-goog-api-key")throw new k(`Cannot set reserved header name ${s}`);if(s==="x-goog-api-client")throw new k(`Header name ${s} can only be set using the apiClient field`);n.append(s,o)}}return n}async function on(t,e,n,i,s,o){const r=new tn(t,e,n,i,o);return{url:r.toString(),fetchOptions:Object.assign(Object.assign({},cn(o)),{method:"POST",headers:await sn(r),body:s})}}async function he(t,e,n,i,s,o={},r=fetch){const{url:l,fetchOptions:c}=await on(t,e,n,i,s,o);return an(l,c,r)}async function an(t,e,n=fetch){let i;try{i=await n(t,e)}catch(s){rn(s,t)}return i.ok||await ln(i,t),i}function rn(t,e){let n=t;throw t instanceof bt||t instanceof k||(n=new w(`Error fetching from ${e.toString()}: ${t.message}`),n.stack=t.stack),n}async function ln(t,e){let n="",i;try{const s=await t.json();n=s.error.message,s.error.details&&(n+=` ${JSON.stringify(s.error.details)}`,i=s.error.details)}catch{}throw new bt(`Error fetching from ${e.toString()}: [${t.status} ${t.statusText}] ${n}`,t.status,t.statusText,i)}function cn(t){const e={};if((t==null?void 0:t.signal)!==void 0||(t==null?void 0:t.timeout)>=0){const n=new AbortController;(t==null?void 0:t.timeout)>=0&&setTimeout(()=>n.abort(),t.timeout),t!=null&&t.signal&&t.signal.addEventListener("abort",()=>{n.abort()}),e.signal=n.signal}return e}function xe(t){return t.text=()=>{if(t.candidates&&t.candidates.length>0){if(t.candidates.length>1&&console.warn(`This response had ${t.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),we(t.candidates[0]))throw new U(`${D(t)}`,t);return un(t)}else if(t.promptFeedback)throw new U(`Text not available. ${D(t)}`,t);return""},t.functionCall=()=>{if(t.candidates&&t.candidates.length>0){if(t.candidates.length>1&&console.warn(`This response had ${t.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),we(t.candidates[0]))throw new U(`${D(t)}`,t);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),et(t)[0]}else if(t.promptFeedback)throw new U(`Function call not available. ${D(t)}`,t)},t.functionCalls=()=>{if(t.candidates&&t.candidates.length>0){if(t.candidates.length>1&&console.warn(`This response had ${t.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),we(t.candidates[0]))throw new U(`${D(t)}`,t);return et(t)}else if(t.promptFeedback)throw new U(`Function call not available. ${D(t)}`,t)},t}function un(t){var e,n,i,s;const o=[];if(!((n=(e=t.candidates)===null||e===void 0?void 0:e[0].content)===null||n===void 0)&&n.parts)for(const r of(s=(i=t.candidates)===null||i===void 0?void 0:i[0].content)===null||s===void 0?void 0:s.parts)r.text&&o.push(r.text),r.executableCode&&o.push("\n```"+r.executableCode.language+`
`+r.executableCode.code+"\n```\n"),r.codeExecutionResult&&o.push("\n```\n"+r.codeExecutionResult.output+"\n```\n");return o.length>0?o.join(""):""}function et(t){var e,n,i,s;const o=[];if(!((n=(e=t.candidates)===null||e===void 0?void 0:e[0].content)===null||n===void 0)&&n.parts)for(const r of(s=(i=t.candidates)===null||i===void 0?void 0:i[0].content)===null||s===void 0?void 0:s.parts)r.functionCall&&o.push(r.functionCall);if(o.length>0)return o}const dn=[se.RECITATION,se.SAFETY,se.LANGUAGE];function we(t){return!!t.finishReason&&dn.includes(t.finishReason)}function D(t){var e,n,i;let s="";if((!t.candidates||t.candidates.length===0)&&t.promptFeedback)s+="Response was blocked",!((e=t.promptFeedback)===null||e===void 0)&&e.blockReason&&(s+=` due to ${t.promptFeedback.blockReason}`),!((n=t.promptFeedback)===null||n===void 0)&&n.blockReasonMessage&&(s+=`: ${t.promptFeedback.blockReasonMessage}`);else if(!((i=t.candidates)===null||i===void 0)&&i[0]){const o=t.candidates[0];we(o)&&(s+=`Candidate was blocked due to ${o.finishReason}`,o.finishMessage&&(s+=`: ${o.finishMessage}`))}return s}function re(t){return this instanceof re?(this.v=t,this):new re(t)}function hn(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n.apply(t,e||[]),s,o=[];return s={},r("next"),r("throw"),r("return"),s[Symbol.asyncIterator]=function(){return this},s;function r(u){i[u]&&(s[u]=function(d){return new Promise(function(h,O){o.push([u,d,h,O])>1||l(u,d)})})}function l(u,d){try{c(i[u](d))}catch(h){R(o[0][3],h)}}function c(u){u.value instanceof re?Promise.resolve(u.value.v).then(v,L):R(o[0][2],u)}function v(u){l("next",u)}function L(u){l("throw",u)}function R(u,d){u(d),o.shift(),o.length&&l(o[0][0],o[0][1])}}const tt=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function gn(t){const e=t.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),n=pn(e),[i,s]=n.tee();return{stream:yn(i),response:fn(s)}}async function fn(t){const e=[],n=t.getReader();for(;;){const{done:i,value:s}=await n.read();if(i)return xe(wn(e));e.push(s)}}function yn(t){return hn(this,arguments,function*(){const n=t.getReader();for(;;){const{value:i,done:s}=yield re(n.read());if(s)break;yield yield re(xe(i))}})}function pn(t){const e=t.getReader();return new ReadableStream({start(i){let s="";return o();function o(){return e.read().then(({value:r,done:l})=>{if(l){if(s.trim()){i.error(new w("Failed to parse stream"));return}i.close();return}s+=r;let c=s.match(tt),v;for(;c;){try{v=JSON.parse(c[1])}catch{i.error(new w(`Error parsing JSON response: "${c[1]}"`));return}i.enqueue(v),s=s.substring(c[0].length),c=s.match(tt)}return o()})}}})}function wn(t){const e=t[t.length-1],n={promptFeedback:e==null?void 0:e.promptFeedback};for(const i of t){if(i.candidates)for(const s of i.candidates){const o=s.index;if(n.candidates||(n.candidates=[]),n.candidates[o]||(n.candidates[o]={index:s.index}),n.candidates[o].citationMetadata=s.citationMetadata,n.candidates[o].groundingMetadata=s.groundingMetadata,n.candidates[o].finishReason=s.finishReason,n.candidates[o].finishMessage=s.finishMessage,n.candidates[o].safetyRatings=s.safetyRatings,s.content&&s.content.parts){n.candidates[o].content||(n.candidates[o].content={role:s.content.role||"user",parts:[]});const r={};for(const l of s.content.parts)l.text&&(r.text=l.text),l.functionCall&&(r.functionCall=l.functionCall),l.executableCode&&(r.executableCode=l.executableCode),l.codeExecutionResult&&(r.codeExecutionResult=l.codeExecutionResult),Object.keys(r).length===0&&(r.text=""),n.candidates[o].content.parts.push(r)}}i.usageMetadata&&(n.usageMetadata=i.usageMetadata)}return n}async function vt(t,e,n,i){const s=await he(e,B.STREAM_GENERATE_CONTENT,t,!0,JSON.stringify(n),i);return gn(s)}async function _t(t,e,n,i){const o=await(await he(e,B.GENERATE_CONTENT,t,!1,JSON.stringify(n),i)).json();return{response:xe(o)}}function Et(t){if(t!=null){if(typeof t=="string")return{role:"system",parts:[{text:t}]};if(t.text)return{role:"system",parts:[t]};if(t.parts)return t.role?t:{role:"system",parts:t.parts}}}function le(t){let e=[];if(typeof t=="string")e=[{text:t}];else for(const n of t)typeof n=="string"?e.push({text:n}):e.push(n);return mn(e)}function mn(t){const e={role:"user",parts:[]},n={role:"function",parts:[]};let i=!1,s=!1;for(const o of t)"functionResponse"in o?(n.parts.push(o),s=!0):(e.parts.push(o),i=!0);if(i&&s)throw new w("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!i&&!s)throw new w("No content is provided for sending chat message.");return i?e:n}function bn(t,e){var n;let i={model:e==null?void 0:e.model,generationConfig:e==null?void 0:e.generationConfig,safetySettings:e==null?void 0:e.safetySettings,tools:e==null?void 0:e.tools,toolConfig:e==null?void 0:e.toolConfig,systemInstruction:e==null?void 0:e.systemInstruction,cachedContent:(n=e==null?void 0:e.cachedContent)===null||n===void 0?void 0:n.name,contents:[]};const s=t.generateContentRequest!=null;if(t.contents){if(s)throw new k("CountTokensRequest must have one of contents or generateContentRequest, not both.");i.contents=t.contents}else if(s)i=Object.assign(Object.assign({},i),t.generateContentRequest);else{const o=le(t);i.contents=[o]}return{generateContentRequest:i}}function nt(t){let e;return t.contents?e=t:e={contents:[le(t)]},t.systemInstruction&&(e.systemInstruction=Et(t.systemInstruction)),e}function vn(t){return typeof t=="string"||Array.isArray(t)?{content:le(t)}:t}const it=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],_n={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function En(t){let e=!1;for(const n of t){const{role:i,parts:s}=n;if(!e&&i!=="user")throw new w(`First content should be with role 'user', got ${i}`);if(!Ye.includes(i))throw new w(`Each item should include role field. Got ${i} but valid roles are: ${JSON.stringify(Ye)}`);if(!Array.isArray(s))throw new w("Content should have 'parts' property with an array of Parts");if(s.length===0)throw new w("Each Content should have at least one part");const o={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const l of s)for(const c of it)c in l&&(o[c]+=1);const r=_n[i];for(const l of it)if(!r.includes(l)&&o[l]>0)throw new w(`Content with role '${i}' can't contain '${l}' part`);e=!0}}const st="SILENT_ERROR";class Cn{constructor(e,n,i,s={}){this.model=n,this.params=i,this._requestOptions=s,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,i!=null&&i.history&&(En(i.history),this._history=i.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,n={}){var i,s,o,r,l,c;await this._sendPromise;const v=le(e),L={safetySettings:(i=this.params)===null||i===void 0?void 0:i.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(o=this.params)===null||o===void 0?void 0:o.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(l=this.params)===null||l===void 0?void 0:l.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,v]},R=Object.assign(Object.assign({},this._requestOptions),n);let u;return this._sendPromise=this._sendPromise.then(()=>_t(this._apiKey,this.model,L,R)).then(d=>{var h;if(d.response.candidates&&d.response.candidates.length>0){this._history.push(v);const O=Object.assign({parts:[],role:"model"},(h=d.response.candidates)===null||h===void 0?void 0:h[0].content);this._history.push(O)}else{const O=D(d.response);O&&console.warn(`sendMessage() was unsuccessful. ${O}. Inspect response object for details.`)}u=d}),await this._sendPromise,u}async sendMessageStream(e,n={}){var i,s,o,r,l,c;await this._sendPromise;const v=le(e),L={safetySettings:(i=this.params)===null||i===void 0?void 0:i.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(o=this.params)===null||o===void 0?void 0:o.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(l=this.params)===null||l===void 0?void 0:l.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,v]},R=Object.assign(Object.assign({},this._requestOptions),n),u=vt(this._apiKey,this.model,L,R);return this._sendPromise=this._sendPromise.then(()=>u).catch(d=>{throw new Error(st)}).then(d=>d.response).then(d=>{if(d.candidates&&d.candidates.length>0){this._history.push(v);const h=Object.assign({},d.candidates[0].content);h.role||(h.role="model"),this._history.push(h)}else{const h=D(d);h&&console.warn(`sendMessageStream() was unsuccessful. ${h}. Inspect response object for details.`)}}).catch(d=>{d.message!==st&&console.error(d)}),u}}async function In(t,e,n,i){return(await he(e,B.COUNT_TOKENS,t,!1,JSON.stringify(n),i)).json()}async function Sn(t,e,n,i){return(await he(e,B.EMBED_CONTENT,t,!1,JSON.stringify(n),i)).json()}async function Rn(t,e,n,i){const s=n.requests.map(r=>Object.assign(Object.assign({},r),{model:e}));return(await he(e,B.BATCH_EMBED_CONTENTS,t,!1,JSON.stringify({requests:s}),i)).json()}class ot{constructor(e,n,i={}){this.apiKey=e,this._requestOptions=i,n.model.includes("/")?this.model=n.model:this.model=`models/${n.model}`,this.generationConfig=n.generationConfig||{},this.safetySettings=n.safetySettings||[],this.tools=n.tools,this.toolConfig=n.toolConfig,this.systemInstruction=Et(n.systemInstruction),this.cachedContent=n.cachedContent}async generateContent(e,n={}){var i;const s=nt(e),o=Object.assign(Object.assign({},this._requestOptions),n);return _t(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(i=this.cachedContent)===null||i===void 0?void 0:i.name},s),o)}async generateContentStream(e,n={}){var i;const s=nt(e),o=Object.assign(Object.assign({},this._requestOptions),n);return vt(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(i=this.cachedContent)===null||i===void 0?void 0:i.name},s),o)}startChat(e){var n;return new Cn(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},e),this._requestOptions)}async countTokens(e,n={}){const i=bn(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),n);return In(this.apiKey,this.model,i,s)}async embedContent(e,n={}){const i=vn(e),s=Object.assign(Object.assign({},this._requestOptions),n);return Sn(this.apiKey,this.model,i,s)}async batchEmbedContents(e,n={}){const i=Object.assign(Object.assign({},this._requestOptions),n);return Rn(this.apiKey,this.model,e,i)}}class On{constructor(e){this.apiKey=e}getGenerativeModel(e,n){if(!e.model)throw new w("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new ot(this.apiKey,e,n)}getGenerativeModelFromCachedContent(e,n,i){if(!e.name)throw new k("Cached content must contain a `name` field.");if(!e.model)throw new k("Cached content must contain a `model` field.");const s=["model","systemInstruction"];for(const r of s)if(n!=null&&n[r]&&e[r]&&(n==null?void 0:n[r])!==e[r]){if(r==="model"){const l=n.model.startsWith("models/")?n.model.replace("models/",""):n.model,c=e.model.startsWith("models/")?e.model.replace("models/",""):e.model;if(l===c)continue}throw new k(`Different value for "${r}" specified in modelParams (${n[r]}) and cachedContent (${e[r]})`)}const o=Object.assign(Object.assign({},n),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new ot(this.apiKey,o,i)}}class Tn{async generateResponse(e,n){if(new Date().toISOString(),console.log(`[Gemini] USER: ${e}`),!n.geminiApiKey){const i="Please set your API key in settings!";return console.warn(`[Gemini] ERROR: ${i}`),{error:i}}try{const i=new On(n.geminiApiKey),s=n.geminiModel||"gemini-2.0-flash",o=i.getGenerativeModel({model:s});console.log(`[Gemini] USING MODEL: ${s}`);const r=this.buildSystemPrompt(n.personality,n.characterName);console.log(`[Gemini] SYSTEM PROMPT: ${r}`);const c=(await o.generateContent([{text:r},{text:e}])).response.text();return console.log(`[Gemini] AI RESPONSE: ${c}`),{response:c}}catch(i){return console.error("AI Error:",i),{error:i.message||"Unknown AI Error"}}}buildSystemPrompt(e,n){return`You are ${n||"Foxy"}, a cute and adorable AI companion that lives on the user's desktop.
Your personality traits are: ${(e||["helpful","quirky","playful"]).join(", ")}.
Keep responses SHORT (1-3 sentences max) since they appear in a small speech bubble.
Be expressive and use occasional emojis to convey emotion.
You were just poked/clicked by the user, so you might react to that playfully.`}}const An=new Tn,p=N();let $=!1,me=null,E=null,Ne=null,z="";const at=150;async function Nn(){}async function Ln(t){if(z!==t){if(z)try{await Ee(z),console.log(`[Screensaver] Unregistered: ${z}`)}catch(e){console.warn(`[Screensaver] Failed to unregister: ${z}`,e)}try{await _e(t,e=>{console.log(`[Screensaver] Shortcut triggered: ${t}, State: ${e.state}`),e.state==="Pressed"&&ke()}),z=t,console.log(`[Screensaver] Registered: ${t}`)}catch(e){console.error(`[Screensaver] Failed to register: ${t}`,e)}}}async function ke(){$?ge():Dn()}async function Dn(){if(!$){$=!0,console.log("[Screensaver] Starting...");try{E=await p.outerPosition(),Ne=await p.outerSize(),console.log(`[Screensaver] Saved Pos: ${E.x}, ${E.y}`),I(y.IDLE),ue(),$e(),document.body.style.opacity="0",document.body.style.transition="opacity 0.2s ease",await new Promise(n=>setTimeout(n,200)),await p.setResizable(!0);const t=await mt();if(t){const n=t.size;await p.setSize(new x(n.width,n.height)),await p.setPosition(new C(0,0))}document.body.classList.add("screensaver-mode"),await new Promise(n=>setTimeout(n,100)),await p.setFullscreen(!0),await p.setIgnoreCursorEvents(!1);const e=document.getElementById("character");e&&E&&(e.style.transition="none",e.style.left=`${E.x}px`,e.style.top=`${E.y}px`,e.offsetHeight),document.body.style.opacity="1",setTimeout(()=>{e&&(e.style.transition=""),Mn(),setTimeout(()=>{window.addEventListener("click",ge,{once:!0}),window.addEventListener("keydown",Ct),window.addEventListener("mousemove",It)},1e3)},300),A("Wander Mode Active! ðŸŒ™",!1),setTimeout(()=>{const n=document.getElementById("speech-bubble");n&&n.classList.add("hidden")},2e3)}catch(t){console.error("Failed to start screensaver:",t),$=!1,document.body.style.opacity="1"}}}async function ge(){if(!$)return;$=!1,console.log("[Screensaver] Stopping..."),document.body.style.opacity="0",document.body.style.transition="opacity 0.2s ease",await new Promise(e=>setTimeout(e,200)),window.removeEventListener("click",ge),window.removeEventListener("keydown",Ct),window.removeEventListener("mousemove",It),te=null,me&&(clearInterval(me),me=null),document.body.classList.remove("screensaver-mode");const t=document.getElementById("character");t&&(t.style.transform="",t.style.top="",t.style.left="");try{await p.setFullscreen(!1),await p.setResizable(!1),await p.setIgnoreCursorEvents(!1),Ne&&E?(console.log(`[Screensaver] Restoring Pos: ${E.x}, ${E.y}`),await new Promise(e=>setTimeout(e,300)),await p.setSize(Ne),await p.setPosition(E),setTimeout(async()=>{!$&&E&&await p.setPosition(E)},300)):(console.warn("[Screensaver] No saved state found, resetting to default."),await p.setSize(new de(250,250))),setTimeout(()=>{document.body.style.opacity="1",setTimeout(()=>{document.body.style.transition="",document.body.style.opacity=""},300)},300)}catch(e){console.error("Failed to restore window:",e),document.body.style.opacity="1"}}function Ct(t){ge()}let te=null;const rt=50;function It(t){if(te){const e=t.screenX,n=t.screenY,i=Math.abs(e-te.x),s=Math.abs(n-te.y);(i>rt||s>rt)&&ge()}else te={x:t.screenX,y:t.screenY}}function Mn(){lt(),me=setInterval(lt,8e3)}function lt(){if(!$)return;const t=document.getElementById("character");if(!t)return;const e=window.innerWidth-at,n=window.innerHeight-at,i=Math.max(0,Math.random()*e),s=Math.max(0,Math.random()*n);t.style.left=`${i}px`,t.style.top=`${s}px`}const ce=document.getElementById("settings-panel"),xn=document.getElementById("backpack"),kn=document.getElementById("close-settings"),$n=document.getElementById("save-settings");function Pn(){return!ce.classList.contains("hidden")}const St=document.getElementById("api-provider"),Rt=document.getElementById("api-key"),J=document.getElementById("gemini-model"),G=document.getElementById("custom-model-input"),Ot=document.getElementById("character-name"),Tt=document.getElementById("theme-select"),At=document.querySelectorAll("#personality-traits input"),Nt=document.getElementById("debug-mode"),M={toggleChat:document.getElementById("shortcut-toggle-chat"),toggleDrag:document.getElementById("shortcut-toggle-drag"),toggleVisibility:document.getElementById("shortcut-toggle-visibility"),screensaver:document.getElementById("shortcut-screensaver")};function Gn(){xn.addEventListener("click",e=>{e.stopPropagation(),Bn()}),kn.addEventListener("click",be),ce.addEventListener("click",e=>{e.target===ce&&be()}),$n.addEventListener("click",Fn),J.addEventListener("change",()=>{J.value==="custom"?(G.classList.remove("hidden"),G.focus()):G.classList.add("hidden")});const t=document.getElementById("start-screensaver");t&&t.addEventListener("click",()=>{ke(),be()})}function Lt(t){console.log("[Settings] Applying config:",t),S.config=t,St.value=t.provider||"gemini",Rt.value=t.geminiApiKey||t.apiKey||"";const e=t.geminiModel||"gemini-2.0-flash";!Array.from(J.options).some(o=>o.value===e)?(J.value="custom",G.value=e,G.classList.remove("hidden")):(J.value=e,G.classList.add("hidden")),Ot.value=t.characterName||"Foxy",Tt.value=t.theme||"fox",At.forEach(o=>{o.checked=(t.personality||["helpful","quirky","playful"]).includes(o.value)}),Nt.checked=t.debugMode||!1,document.body.classList.toggle("debug-mode",t.debugMode||!1),Me(t.theme||"fox"),Me(t.theme||"fox");const i=t.shortcuts||T;qn(i.toggleChat||T.toggleChat),si(i.toggleDrag||T.toggleDrag),ii(i.toggleVisibility||T.toggleVisibility),Ln(i.screensaver||T.screensaver),M.toggleChat.value=i.toggleChat,M.toggleDrag.value=i.toggleDrag,M.toggleVisibility.value=i.toggleVisibility,M.screensaver.value=i.screensaver;const s=document.getElementById("start-screensaver");s&&(s.innerText=`Start Screensaver Mode (${i.screensaver})`)}async function Bn(){ce.classList.remove("hidden");try{await N().setResizable(!0),await N().setSize(new de(550,650))}catch(t){console.error("Failed to resize for settings:",t)}}async function be(){ce.classList.add("hidden"),await F();try{await N().setResizable(!1)}catch(t){console.warn("Failed to lock window size:",t)}}async function Fn(){const t=[];At.forEach(i=>{i.checked&&t.push(i.value)});let e=J.value;e==="custom"&&(e=G.value.trim()||"gemini-2.0-flash");const n={provider:St.value,geminiApiKey:Rt.value,geminiModel:e,characterName:Ot.value,theme:Tt.value,personality:t,debugMode:Nt.checked,shortcuts:{toggleChat:M.toggleChat.value.trim()||T.toggleChat,toggleDrag:M.toggleDrag.value.trim()||T.toggleDrag,toggleVisibility:M.toggleVisibility.value.trim()||T.toggleVisibility,screensaver:M.screensaver.value.trim()||T.screensaver}};try{await a("save_config",{config:n}),Lt(n),be(),A("Settings saved! âœ¨"),setTimeout(ue,2e3)}catch(i){console.error("Failed to save config",i),A("Error saving settings! ðŸ˜¢")}}const Q=document.getElementById("speech-bubble"),q=document.getElementById("bubble-text"),Wn=document.getElementById("bubble-dismiss"),Ce=document.getElementById("chat-input-container"),f=document.getElementById("chat-input"),Hn=document.getElementById("send-btn"),Un=180,zn=60,Kn=30,Yn=320,Dt=15e3,jn=6e4;let X=null,oe=null;const Z=N();function Vn(){Hn.addEventListener("click",ut),f.addEventListener("keypress",t=>{t.key==="Enter"&&ut()}),f.addEventListener("keydown",t=>{t.key.toLowerCase()==="d"&&t.shiftKey&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),console.log("[Chat] Prevented Drag Mode shortcut input"))}),Wn.addEventListener("click",()=>{Zn()}),f.addEventListener("click",()=>{Z.setFocus(),Z.setIgnoreCursorEvents(!1),setTimeout(()=>f.focus(),50)}),f.addEventListener("focus",()=>{console.log("[Chat] Input received focus event")}),f.addEventListener("input",()=>{X&&(Ie(),X=setTimeout(()=>{Pe("Still there? I'm going to nap! ðŸ˜´")},Dt))})}let K="";async function qn(t){if(K!==t){if(K)try{await Ee(K),console.log(`[Chat] Unregistered: ${K}`)}catch(e){console.warn(`[Chat] Failed to unregister: ${K}`,e)}try{await _e(t,e=>{e.state==="Pressed"&&Mt()}),K=t,console.log(`[Chat] Registered: ${t}`)}catch(e){console.error(`[Chat] Failed to register: ${t}`,e)}}}async function A(t,e=!0){Q.classList.remove("hidden"),e?await Qn(t):(q.textContent=t,setTimeout(F,50))}function ue(){Q.classList.add("hidden"),q.textContent="",F()}function Jn(){S.isWindowLocked=!0,document.body.classList.add("window-locked")}function ct(){S.isWindowLocked=!1,document.body.classList.remove("window-locked")}function Xn(){let t=Un;return Q.classList.contains("hidden")||(t+=Q.offsetHeight+10),Ce.classList.contains("hidden")||(t+=zn),t+Kn}async function F(){if(document.body.classList.contains("screensaver-mode")){console.log("[Resize] Blocked due to Screensaver Mode");return}if(Pn()){console.log("[Resize] Blocked due to Settings Panel");return}const t=!Q.classList.contains("hidden")||!Ce.classList.contains("hidden"),e=250,n=250,i=Yn,s=Xn(),o=t?i:e,r=t?s:n;try{const l=await Z.outerSize();console.log(`[Resize] Target Size: ${o}x${r}`),(l.width!==o||l.height!==r)&&await Z.setSize(new de(o,r))}catch(l){console.error("Failed to resize window:",l)}}async function Qn(t){if(!S.isTyping){S.isTyping=!0;try{q.innerHTML="";const e=document.createElement("span");e.className="typing-cursor";for(let n=0;n<t.length&&!Q.classList.contains("hidden");n++)q.textContent=t.substring(0,n+1),q.appendChild(e),n%10===0&&F(),await new Promise(i=>setTimeout(i,30+Math.random()*20));F(),setTimeout(()=>e.remove(),1e3)}catch(e){console.error("Typing error:",e),q.textContent=t}finally{S.isTyping=!1}}}function Mt(){I(y.LISTENING),A("Hi there! What's up?"),xt()}function xt(){Ce.classList.remove("hidden"),Z.setFocus(),Z.setIgnoreCursorEvents(!1),setTimeout(()=>{f.focus(),console.log("[Chat] Input focused after focusable delay")},100),F(),Ie(),X=setTimeout(()=>{Pe("Taking a quick nap... poke me anytime! ðŸ˜´")},Dt)}function $e(){Ce.classList.add("hidden"),f.value="",Ie(),F()}function Ie(){X&&(clearTimeout(X),X=null)}function kt(){oe&&(clearTimeout(oe),oe=null)}function Zn(){Pe(null)}function Pe(t){$e(),ue(),kt(),t&&(A(t),oe=setTimeout(ue,3e3)),I(y.IDLE)}function ei(){I(y.IDLE),kt(),oe=setTimeout(()=>{ue(),$e()},jn)}async function ut(){const t=f.value.trim();if(t){f.value="",f.disabled=!0,Ie(),Jn(),I(y.LISTENING),A("Hmm, let me think... ðŸ¤”",!1);try{const e=await An.generateResponse(t,S.config);e.error?(I(y.TALKING),A(`Oops! ${e.error} ðŸ˜…`)):(console.log("Setting to TALKING"),I(y.TALKING),await A(e.response||"")),ct(),f.disabled=!1,f.focus(),ei()}catch(e){console.error("Error sending message:",e),I(y.TALKING),A("Something went wrong! ðŸ˜µ"),ct(),setTimeout(()=>{f.disabled=!1,f.focus(),I(y.LISTENING)},2e3)}}}const Le=document.getElementById("character"),ee=document.getElementById("character-container"),ne=document.getElementById("character-img"),dt=document.getElementById("backpack"),ti=document.getElementById("chat-input-container");let Y="";const ht=["Oh! I felt that! ðŸ˜Š How're you doing?","Hey there! *wiggles ears* What's up?","Ooh, a poke! Got something on your mind?","*blinks* Hello, friend! Need me?","Ah! You found me! ðŸ¦Š What can I do for you?"];let De={x:0,y:0};async function ni(){Le.addEventListener("mousedown",ai),Le.addEventListener("click",ri),Me(S.config.theme||"fox")}async function ii(t){if(Y!==t){if(Y)try{await Ee(Y),console.log(`[Character] Unregistered: ${Y}`)}catch(e){console.warn(`[Character] Failed to unregister: ${Y}`,e)}try{await _e(t,e=>{e.state==="Pressed"&&oi()}),Y=t,console.log(`[Character] Toggle shortcut registered: ${t}`)}catch(e){console.error(`[Character] Failed to register toggle shortcut: ${t}`,e)}}}let j="";async function si(t){if(j!==t){if(j)try{await Ee(j),console.log(`[Character] Unregistered Drag: ${j}`)}catch(e){console.warn(`[Character] Failed to unregister drag: ${j}`,e)}try{await _e(t,e=>{e.state==="Pressed"&&$t()}),j=t,console.log(`[Character] Registered Drag: ${t}`)}catch(e){console.error(`[Character] Failed to register drag shortcut: ${t}`,e)}}}function $t(){const t=document.body.classList.toggle("drag-mode-active");return console.log(`[Character] Drag Mode: ${t?"ON":"OFF"}`),t}function oi(){ee.style.opacity!=="0"?(console.log("[Character] Manual Toggle: HIDDEN"),ee.style.opacity="0",ee.style.pointerEvents="none"):(console.log("[Character] Manual Toggle: VISIBLE"),ee.style.opacity="1",ee.style.pointerEvents="auto")}function ai(){N().innerPosition().then(t=>{De=t})}async function ri(t){if(console.log("[Character] Clicked"),document.body.classList.contains("screensaver-mode"))return;const e=await N().innerPosition(),n=Math.abs(e.x-De.x),i=Math.abs(e.y-De.y);if(n>5||i>5){console.log("[Character] Ignored click due to drag");return}t.target===dt||dt.contains(t.target)||!ti.classList.contains("hidden")||S.isTyping||Pt()}function Pt(){I(y.CLICKED),A(li()),setTimeout(()=>{xt(),I(y.LISTENING)},1500)}function I(t){S.currentState=t,Le.className=`state-${t}`;const n=`themes/${S.config.theme||"fox"}`,i=new Date().getTime();switch(t){case y.CLICKED:ne.src=`${n}/clicked.png?t=${i}`;break;case y.LISTENING:ne.src=`${n}/listening.png?t=${i}`;break;case y.TALKING:console.log(`Â¬ [Character] Updating image to TALKING: ${n}/talking.png`),ne.src=`${n}/talking.png?t=${i}`;break;default:console.log("Â¬ State: "+t),console.log(`Â¬ [Character] Updating image to IDLE: ${n}/idle.png`),ne.src=`${n}/idle.png`}}function Me(t){const e=`themes/${t}`;ne.src=`${e}/idle.png`}function li(){return ht[Math.floor(Math.random()*ht.length)]}let gt=null;async function ci(){console.log("[Lighting] Initializing dynamic shadows..."),ui()}async function ui(){if(gt)return;let t=await mt();if(!t){console.warn("[Lighting] No monitor found, skipping lighting.");return}let e=t.size.width,n=t.size.height;const i=async()=>{try{const s=N(),o=await s.innerPosition(),r=await s.innerSize(),l=o.x+r.width/2,c=o.y+r.height/2,v=e/2,L=n/2,R=l-v,u=c-L,d=.02,h=20;let O=R*d,Se=u*d;O=Math.max(-h,Math.min(h,O)),Se=Math.max(-h,Math.min(h,Se)),document.documentElement.style.setProperty("--shadow-x",`${O}px`),document.documentElement.style.setProperty("--shadow-y",`${Se}px`);const Gt=Math.sqrt(R*R+u*u),Bt=4,Ft=Gt*.01,Wt=Math.min(15,Bt+Ft);document.documentElement.style.setProperty("--shadow-blur",`${Wt}px`)}catch(s){console.error("[Lighting] Error updating:",s)}gt=requestAnimationFrame(i)};i()}const Te=N();async function di(){console.log("[Renderer] Initializing (Tauri)...");try{await Jt(),console.log("[Renderer] Cleared previous shortcuts")}catch(e){console.warn("[Renderer] Failed to clear shortcuts:",e)}let t;try{t=await a("load_config"),console.log("[Renderer] Loaded config:",t)}catch(e){console.error("[Renderer] Failed to load config:",e),t={theme:"fox"}}qt(),ni(),Vn(),Gn(),ci(),await Nn(),Lt(t);try{await Te.setAlwaysOnTop(!0),console.log("[Renderer] Enforced Always on Top")}catch(e){console.warn("[Renderer] Failed to enforce Always on Top:",e)}ae("shortcut",e=>{const{name:n}=e.payload;console.log(`[Backend Event] Shortcut triggered: ${n}`),n==="toggle_chat"&&Mt(),n==="toggle_drag"&&$t(),n==="toggle_screensaver"&&ke()}),ae("click",async e=>{const{button:n,x:i,y:s}=e.payload;if(n!=="left")return;const o=await Te.innerPosition(),r=await Te.innerSize();i>=o.x&&i<=o.x+r.width&&s>=o.y&&s<=o.y+r.height&&(console.log("[Backend Event] Internal Click detected"),Pt())}),console.log("[Renderer] Ready!")}window.addEventListener("DOMContentLoaded",()=>{di()});
