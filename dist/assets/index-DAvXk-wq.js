(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();function y(t,e,n,i){if(typeof e=="function"?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?i:n==="a"?i.call(t):i?i.value:e.get(t)}function J(t,e,n,i,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n}var F,C,U,fe,pe;const _="__TAURI_TO_IPC_KEY__";function yt(t,e=!1){return window.__TAURI_INTERNALS__.transformCallback(t,e)}class Ut{constructor(e){F.set(this,void 0),C.set(this,0),U.set(this,[]),fe.set(this,void 0),J(this,F,e||(()=>{})),this.id=yt(n=>{const i=n.index;if("end"in n){i==y(this,C,"f")?this.cleanupCallback():J(this,fe,i);return}const s=n.message;if(i==y(this,C,"f")){for(y(this,F,"f").call(this,s),J(this,C,y(this,C,"f")+1);y(this,C,"f")in y(this,U,"f");){const o=y(this,U,"f")[y(this,C,"f")];y(this,F,"f").call(this,o),delete y(this,U,"f")[y(this,C,"f")],J(this,C,y(this,C,"f")+1)}y(this,C,"f")===y(this,fe,"f")&&this.cleanupCallback()}else y(this,U,"f")[i]=s})}cleanupCallback(){window.__TAURI_INTERNALS__.unregisterCallback(this.id)}set onmessage(e){J(this,F,e)}get onmessage(){return y(this,F,"f")}[(F=new WeakMap,C=new WeakMap,U=new WeakMap,fe=new WeakMap,_)](){return`__CHANNEL__:${this.id}`}toJSON(){return this[_]()}}async function a(t,e={},n){return window.__TAURI_INTERNALS__.invoke(t,e,n)}class zt{get rid(){return y(this,pe,"f")}constructor(e){pe.set(this,void 0),J(this,pe,e)}async close(){return a("plugin:resources|close",{rid:this.rid})}}pe=new WeakMap;class de{constructor(...e){this.type="Logical",e.length===1?"Logical"in e[0]?(this.width=e[0].Logical.width,this.height=e[0].Logical.height):(this.width=e[0].width,this.height=e[0].height):(this.width=e[0],this.height=e[1])}toPhysical(e){return new k(this.width*e,this.height*e)}[_](){return{width:this.width,height:this.height}}toJSON(){return this[_]()}}class k{constructor(...e){this.type="Physical",e.length===1?"Physical"in e[0]?(this.width=e[0].Physical.width,this.height=e[0].Physical.height):(this.width=e[0].width,this.height=e[0].height):(this.width=e[0],this.height=e[1])}toLogical(e){return new de(this.width/e,this.height/e)}[_](){return{width:this.width,height:this.height}}toJSON(){return this[_]()}}class z{constructor(e){this.size=e}toLogical(e){return this.size instanceof de?this.size:this.size.toLogical(e)}toPhysical(e){return this.size instanceof k?this.size:this.size.toPhysical(e)}[_](){return{[`${this.size.type}`]:{width:this.size.width,height:this.size.height}}}toJSON(){return this[_]()}}class pt{constructor(...e){this.type="Logical",e.length===1?"Logical"in e[0]?(this.x=e[0].Logical.x,this.y=e[0].Logical.y):(this.x=e[0].x,this.y=e[0].y):(this.x=e[0],this.y=e[1])}toPhysical(e){return new T(this.x*e,this.y*e)}[_](){return{x:this.x,y:this.y}}toJSON(){return this[_]()}}class T{constructor(...e){this.type="Physical",e.length===1?"Physical"in e[0]?(this.x=e[0].Physical.x,this.y=e[0].Physical.y):(this.x=e[0].x,this.y=e[0].y):(this.x=e[0],this.y=e[1])}toLogical(e){return new pt(this.x/e,this.y/e)}[_](){return{x:this.x,y:this.y}}toJSON(){return this[_]()}}class ye{constructor(e){this.position=e}toLogical(e){return this.position instanceof pt?this.position:this.position.toLogical(e)}toPhysical(e){return this.position instanceof T?this.position:this.position.toPhysical(e)}[_](){return{[`${this.position.type}`]:{x:this.position.x,y:this.position.y}}}toJSON(){return this[_]()}}var E;(function(t){t.WINDOW_RESIZED="tauri://resize",t.WINDOW_MOVED="tauri://move",t.WINDOW_CLOSE_REQUESTED="tauri://close-requested",t.WINDOW_DESTROYED="tauri://destroyed",t.WINDOW_FOCUS="tauri://focus",t.WINDOW_BLUR="tauri://blur",t.WINDOW_SCALE_FACTOR_CHANGED="tauri://scale-change",t.WINDOW_THEME_CHANGED="tauri://theme-changed",t.WINDOW_CREATED="tauri://window-created",t.WEBVIEW_CREATED="tauri://webview-created",t.DRAG_ENTER="tauri://drag-enter",t.DRAG_OVER="tauri://drag-over",t.DRAG_DROP="tauri://drag-drop",t.DRAG_LEAVE="tauri://drag-leave"})(E||(E={}));async function mt(t,e){window.__TAURI_EVENT_PLUGIN_INTERNALS__.unregisterListener(t,e),await a("plugin:event|unlisten",{event:t,eventId:e})}async function Z(t,e,n){var i;const s=typeof(n==null?void 0:n.target)=="string"?{kind:"AnyLabel",label:n.target}:(i=n==null?void 0:n.target)!==null&&i!==void 0?i:{kind:"Any"};return a("plugin:event|listen",{event:t,target:s,handler:yt(e)}).then(o=>async()=>mt(t,o))}async function Kt(t,e,n){return Z(t,i=>{mt(t,i.id),e(i)},n)}async function Yt(t,e){await a("plugin:event|emit",{event:t,payload:e})}async function jt(t,e,n){await a("plugin:event|emit_to",{target:typeof t=="string"?{kind:"AnyLabel",label:t}:t,event:e,payload:n})}class se extends zt{constructor(e){super(e)}static async new(e,n,i){return a("plugin:image|new",{rgba:ve(e),width:n,height:i}).then(s=>new se(s))}static async fromBytes(e){return a("plugin:image|from_bytes",{bytes:ve(e)}).then(n=>new se(n))}static async fromPath(e){return a("plugin:image|from_path",{path:e}).then(n=>new se(n))}async rgba(){return a("plugin:image|rgba",{rid:this.rid}).then(e=>new Uint8Array(e))}async size(){return a("plugin:image|size",{rid:this.rid})}}function ve(t){return t==null?null:typeof t=="string"?t:t instanceof se?t.rid:t}var Ae;(function(t){t[t.Critical=1]="Critical",t[t.Informational=2]="Informational"})(Ae||(Ae={}));class Vt{constructor(e){this._preventDefault=!1,this.event=e.event,this.id=e.id}preventDefault(){this._preventDefault=!0}isPreventDefault(){return this._preventDefault}}var Be;(function(t){t.None="none",t.Normal="normal",t.Indeterminate="indeterminate",t.Paused="paused",t.Error="error"})(Be||(Be={}));function R(){return new wt(window.__TAURI_INTERNALS__.metadata.currentWindow.label,{skip:!0})}async function Re(){return a("plugin:window|get_all_windows").then(t=>t.map(e=>new wt(e,{skip:!0})))}const Te=["tauri://created","tauri://error"];class wt{constructor(e,n={}){var i;this.label=e,this.listeners=Object.create(null),n!=null&&n.skip||a("plugin:window|create",{options:{...n,parent:typeof n.parent=="string"?n.parent:(i=n.parent)===null||i===void 0?void 0:i.label,label:e}}).then(async()=>this.emit("tauri://created")).catch(async s=>this.emit("tauri://error",s))}static async getByLabel(e){var n;return(n=(await Re()).find(i=>i.label===e))!==null&&n!==void 0?n:null}static getCurrent(){return R()}static async getAll(){return Re()}static async getFocusedWindow(){for(const e of await Re())if(await e.isFocused())return e;return null}async listen(e,n){return this._handleTauriEvent(e,n)?()=>{const i=this.listeners[e];i.splice(i.indexOf(n),1)}:Z(e,n,{target:{kind:"Window",label:this.label}})}async once(e,n){return this._handleTauriEvent(e,n)?()=>{const i=this.listeners[e];i.splice(i.indexOf(n),1)}:Kt(e,n,{target:{kind:"Window",label:this.label}})}async emit(e,n){if(Te.includes(e)){for(const i of this.listeners[e]||[])i({event:e,id:-1,payload:n});return}return Yt(e,n)}async emitTo(e,n,i){if(Te.includes(n)){for(const s of this.listeners[n]||[])s({event:n,id:-1,payload:i});return}return jt(e,n,i)}_handleTauriEvent(e,n){return Te.includes(e)?(e in this.listeners?this.listeners[e].push(n):this.listeners[e]=[n],!0):!1}async scaleFactor(){return a("plugin:window|scale_factor",{label:this.label})}async innerPosition(){return a("plugin:window|inner_position",{label:this.label}).then(e=>new T(e))}async outerPosition(){return a("plugin:window|outer_position",{label:this.label}).then(e=>new T(e))}async innerSize(){return a("plugin:window|inner_size",{label:this.label}).then(e=>new k(e))}async outerSize(){return a("plugin:window|outer_size",{label:this.label}).then(e=>new k(e))}async isFullscreen(){return a("plugin:window|is_fullscreen",{label:this.label})}async isMinimized(){return a("plugin:window|is_minimized",{label:this.label})}async isMaximized(){return a("plugin:window|is_maximized",{label:this.label})}async isFocused(){return a("plugin:window|is_focused",{label:this.label})}async isDecorated(){return a("plugin:window|is_decorated",{label:this.label})}async isResizable(){return a("plugin:window|is_resizable",{label:this.label})}async isMaximizable(){return a("plugin:window|is_maximizable",{label:this.label})}async isMinimizable(){return a("plugin:window|is_minimizable",{label:this.label})}async isClosable(){return a("plugin:window|is_closable",{label:this.label})}async isVisible(){return a("plugin:window|is_visible",{label:this.label})}async title(){return a("plugin:window|title",{label:this.label})}async theme(){return a("plugin:window|theme",{label:this.label})}async isAlwaysOnTop(){return a("plugin:window|is_always_on_top",{label:this.label})}async center(){return a("plugin:window|center",{label:this.label})}async requestUserAttention(e){let n=null;return e&&(e===Ae.Critical?n={type:"Critical"}:n={type:"Informational"}),a("plugin:window|request_user_attention",{label:this.label,value:n})}async setResizable(e){return a("plugin:window|set_resizable",{label:this.label,value:e})}async setEnabled(e){return a("plugin:window|set_enabled",{label:this.label,value:e})}async isEnabled(){return a("plugin:window|is_enabled",{label:this.label})}async setMaximizable(e){return a("plugin:window|set_maximizable",{label:this.label,value:e})}async setMinimizable(e){return a("plugin:window|set_minimizable",{label:this.label,value:e})}async setClosable(e){return a("plugin:window|set_closable",{label:this.label,value:e})}async setTitle(e){return a("plugin:window|set_title",{label:this.label,value:e})}async maximize(){return a("plugin:window|maximize",{label:this.label})}async unmaximize(){return a("plugin:window|unmaximize",{label:this.label})}async toggleMaximize(){return a("plugin:window|toggle_maximize",{label:this.label})}async minimize(){return a("plugin:window|minimize",{label:this.label})}async unminimize(){return a("plugin:window|unminimize",{label:this.label})}async show(){return a("plugin:window|show",{label:this.label})}async hide(){return a("plugin:window|hide",{label:this.label})}async close(){return a("plugin:window|close",{label:this.label})}async destroy(){return a("plugin:window|destroy",{label:this.label})}async setDecorations(e){return a("plugin:window|set_decorations",{label:this.label,value:e})}async setShadow(e){return a("plugin:window|set_shadow",{label:this.label,value:e})}async setEffects(e){return a("plugin:window|set_effects",{label:this.label,value:e})}async clearEffects(){return a("plugin:window|set_effects",{label:this.label,value:null})}async setAlwaysOnTop(e){return a("plugin:window|set_always_on_top",{label:this.label,value:e})}async setAlwaysOnBottom(e){return a("plugin:window|set_always_on_bottom",{label:this.label,value:e})}async setContentProtected(e){return a("plugin:window|set_content_protected",{label:this.label,value:e})}async setSize(e){return a("plugin:window|set_size",{label:this.label,value:e instanceof z?e:new z(e)})}async setMinSize(e){return a("plugin:window|set_min_size",{label:this.label,value:e instanceof z?e:e?new z(e):null})}async setMaxSize(e){return a("plugin:window|set_max_size",{label:this.label,value:e instanceof z?e:e?new z(e):null})}async setSizeConstraints(e){function n(i){return i?{Logical:i}:null}return a("plugin:window|set_size_constraints",{label:this.label,value:{minWidth:n(e==null?void 0:e.minWidth),minHeight:n(e==null?void 0:e.minHeight),maxWidth:n(e==null?void 0:e.maxWidth),maxHeight:n(e==null?void 0:e.maxHeight)}})}async setPosition(e){return a("plugin:window|set_position",{label:this.label,value:e instanceof ye?e:new ye(e)})}async setFullscreen(e){return a("plugin:window|set_fullscreen",{label:this.label,value:e})}async setSimpleFullscreen(e){return a("plugin:window|set_simple_fullscreen",{label:this.label,value:e})}async setFocus(){return a("plugin:window|set_focus",{label:this.label})}async setFocusable(e){return a("plugin:window|set_focusable",{label:this.label,value:e})}async setIcon(e){return a("plugin:window|set_icon",{label:this.label,value:ve(e)})}async setSkipTaskbar(e){return a("plugin:window|set_skip_taskbar",{label:this.label,value:e})}async setCursorGrab(e){return a("plugin:window|set_cursor_grab",{label:this.label,value:e})}async setCursorVisible(e){return a("plugin:window|set_cursor_visible",{label:this.label,value:e})}async setCursorIcon(e){return a("plugin:window|set_cursor_icon",{label:this.label,value:e})}async setBackgroundColor(e){return a("plugin:window|set_background_color",{color:e})}async setCursorPosition(e){return a("plugin:window|set_cursor_position",{label:this.label,value:e instanceof ye?e:new ye(e)})}async setIgnoreCursorEvents(e){return a("plugin:window|set_ignore_cursor_events",{label:this.label,value:e})}async startDragging(){return a("plugin:window|start_dragging",{label:this.label})}async startResizeDragging(e){return a("plugin:window|start_resize_dragging",{label:this.label,value:e})}async setBadgeCount(e){return a("plugin:window|set_badge_count",{label:this.label,value:e})}async setBadgeLabel(e){return a("plugin:window|set_badge_label",{label:this.label,value:e})}async setOverlayIcon(e){return a("plugin:window|set_overlay_icon",{label:this.label,value:e?ve(e):void 0})}async setProgressBar(e){return a("plugin:window|set_progress_bar",{label:this.label,value:e})}async setVisibleOnAllWorkspaces(e){return a("plugin:window|set_visible_on_all_workspaces",{label:this.label,value:e})}async setTitleBarStyle(e){return a("plugin:window|set_title_bar_style",{label:this.label,value:e})}async setTheme(e){return a("plugin:window|set_theme",{label:this.label,value:e})}async onResized(e){return this.listen(E.WINDOW_RESIZED,n=>{n.payload=new k(n.payload),e(n)})}async onMoved(e){return this.listen(E.WINDOW_MOVED,n=>{n.payload=new T(n.payload),e(n)})}async onCloseRequested(e){return this.listen(E.WINDOW_CLOSE_REQUESTED,async n=>{const i=new Vt(n);await e(i),i.isPreventDefault()||await this.destroy()})}async onDragDropEvent(e){const n=await this.listen(E.DRAG_ENTER,r=>{e({...r,payload:{type:"enter",paths:r.payload.paths,position:new T(r.payload.position)}})}),i=await this.listen(E.DRAG_OVER,r=>{e({...r,payload:{type:"over",position:new T(r.payload.position)}})}),s=await this.listen(E.DRAG_DROP,r=>{e({...r,payload:{type:"drop",paths:r.payload.paths,position:new T(r.payload.position)}})}),o=await this.listen(E.DRAG_LEAVE,r=>{e({...r,payload:{type:"leave"}})});return()=>{n(),s(),i(),o()}}async onFocusChanged(e){const n=await this.listen(E.WINDOW_FOCUS,s=>{e({...s,payload:!0})}),i=await this.listen(E.WINDOW_BLUR,s=>{e({...s,payload:!1})});return()=>{n(),i()}}async onScaleChanged(e){return this.listen(E.WINDOW_SCALE_FACTOR_CHANGED,e)}async onThemeChanged(e){return this.listen(E.WINDOW_THEME_CHANGED,e)}}var Ge;(function(t){t.Disabled="disabled",t.Throttle="throttle",t.Suspend="suspend"})(Ge||(Ge={}));var Fe;(function(t){t.Default="default",t.FluentOverlay="fluentOverlay"})(Fe||(Fe={}));var He;(function(t){t.AppearanceBased="appearanceBased",t.Light="light",t.Dark="dark",t.MediumLight="mediumLight",t.UltraDark="ultraDark",t.Titlebar="titlebar",t.Selection="selection",t.Menu="menu",t.Popover="popover",t.Sidebar="sidebar",t.HeaderView="headerView",t.Sheet="sheet",t.WindowBackground="windowBackground",t.HudWindow="hudWindow",t.FullScreenUI="fullScreenUI",t.Tooltip="tooltip",t.ContentBackground="contentBackground",t.UnderWindowBackground="underWindowBackground",t.UnderPageBackground="underPageBackground",t.Mica="mica",t.Blur="blur",t.Acrylic="acrylic",t.Tabbed="tabbed",t.TabbedDark="tabbedDark",t.TabbedLight="tabbedLight"})(He||(He={}));var We;(function(t){t.FollowsWindowActiveState="followsWindowActiveState",t.Active="active",t.Inactive="inactive"})(We||(We={}));function qt(t){return t===null?null:{name:t.name,scaleFactor:t.scaleFactor,position:new T(t.position),size:new k(t.size),workArea:{position:new T(t.workArea.position),size:new k(t.workArea.size)}}}async function bt(){return a("plugin:window|current_monitor").then(qt)}function Jt(){console.log("[Interactions] Standard CSS Hover Mode (Windowed)"),Z("cursor-pos",t=>{const{x:e,y:n}=t.payload;Math.random()<.05&&console.log(`[Interactions] Cursor: ${e}, ${n}`)})}async function _e(t,e){const n=new Ut;return n.onmessage=e,await a("plugin:global-shortcut|register",{shortcuts:Array.isArray(t)?t:[t],handler:n})}async function Ee(t){return await a("plugin:global-shortcut|unregister",{shortcuts:Array.isArray(t)?t:[t]})}async function Xt(){return await a("plugin:global-shortcut|unregister_all",{})}const m={IDLE:"idle",CLICKED:"clicked",LISTENING:"listening",TALKING:"talking"},N={toggleChat:"Super+Shift+F",toggleDrag:"Super+Shift+D",toggleVisibility:"Super+Shift+H",screensaver:"Super+Shift+S"},S={currentState:m.IDLE,config:{shortcuts:N},isTyping:!1,hasDragged:!1,isDragging:!1,isWindowLocked:!1};var Ue;(function(t){t.STRING="string",t.NUMBER="number",t.INTEGER="integer",t.BOOLEAN="boolean",t.ARRAY="array",t.OBJECT="object"})(Ue||(Ue={}));var ze;(function(t){t.LANGUAGE_UNSPECIFIED="language_unspecified",t.PYTHON="python"})(ze||(ze={}));var Ke;(function(t){t.OUTCOME_UNSPECIFIED="outcome_unspecified",t.OUTCOME_OK="outcome_ok",t.OUTCOME_FAILED="outcome_failed",t.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded"})(Ke||(Ke={}));const Ye=["user","model","function","system"];var je;(function(t){t.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",t.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",t.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",t.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",t.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(je||(je={}));var Ve;(function(t){t.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",t.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",t.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",t.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",t.BLOCK_NONE="BLOCK_NONE"})(Ve||(Ve={}));var qe;(function(t){t.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",t.NEGLIGIBLE="NEGLIGIBLE",t.LOW="LOW",t.MEDIUM="MEDIUM",t.HIGH="HIGH"})(qe||(qe={}));var Je;(function(t){t.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",t.SAFETY="SAFETY",t.OTHER="OTHER"})(Je||(Je={}));var oe;(function(t){t.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",t.STOP="STOP",t.MAX_TOKENS="MAX_TOKENS",t.SAFETY="SAFETY",t.RECITATION="RECITATION",t.LANGUAGE="LANGUAGE",t.OTHER="OTHER"})(oe||(oe={}));var Xe;(function(t){t.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",t.RETRIEVAL_QUERY="RETRIEVAL_QUERY",t.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",t.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",t.CLASSIFICATION="CLASSIFICATION",t.CLUSTERING="CLUSTERING"})(Xe||(Xe={}));var Qe;(function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.AUTO="AUTO",t.ANY="ANY",t.NONE="NONE"})(Qe||(Qe={}));var Ze;(function(t){t.MODE_UNSPECIFIED="MODE_UNSPECIFIED",t.MODE_DYNAMIC="MODE_DYNAMIC"})(Ze||(Ze={}));class v extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class K extends v{constructor(e,n){super(e),this.response=n}}class vt extends v{constructor(e,n,i,s){super(e),this.status=n,this.statusText=i,this.errorDetails=s}}class P extends v{}const Qt="https://generativelanguage.googleapis.com",Zt="v1beta",en="0.21.0",tn="genai-js";var W;(function(t){t.GENERATE_CONTENT="generateContent",t.STREAM_GENERATE_CONTENT="streamGenerateContent",t.COUNT_TOKENS="countTokens",t.EMBED_CONTENT="embedContent",t.BATCH_EMBED_CONTENTS="batchEmbedContents"})(W||(W={}));class nn{constructor(e,n,i,s,o){this.model=e,this.task=n,this.apiKey=i,this.stream=s,this.requestOptions=o}toString(){var e,n;const i=((e=this.requestOptions)===null||e===void 0?void 0:e.apiVersion)||Zt;let o=`${((n=this.requestOptions)===null||n===void 0?void 0:n.baseUrl)||Qt}/${i}/${this.model}:${this.task}`;return this.stream&&(o+="?alt=sse"),o}}function sn(t){const e=[];return t!=null&&t.apiClient&&e.push(t.apiClient),e.push(`${tn}/${en}`),e.join(" ")}async function on(t){var e;const n=new Headers;n.append("Content-Type","application/json"),n.append("x-goog-api-client",sn(t.requestOptions)),n.append("x-goog-api-key",t.apiKey);let i=(e=t.requestOptions)===null||e===void 0?void 0:e.customHeaders;if(i){if(!(i instanceof Headers))try{i=new Headers(i)}catch(s){throw new P(`unable to convert customHeaders value ${JSON.stringify(i)} to Headers: ${s.message}`)}for(const[s,o]of i.entries()){if(s==="x-goog-api-key")throw new P(`Cannot set reserved header name ${s}`);if(s==="x-goog-api-client")throw new P(`Header name ${s} can only be set using the apiClient field`);n.append(s,o)}}return n}async function an(t,e,n,i,s,o){const r=new nn(t,e,n,i,o);return{url:r.toString(),fetchOptions:Object.assign(Object.assign({},un(o)),{method:"POST",headers:await on(r),body:s})}}async function he(t,e,n,i,s,o={},r=fetch){const{url:l,fetchOptions:c}=await an(t,e,n,i,s,o);return rn(l,c,r)}async function rn(t,e,n=fetch){let i;try{i=await n(t,e)}catch(s){ln(s,t)}return i.ok||await cn(i,t),i}function ln(t,e){let n=t;throw t instanceof vt||t instanceof P||(n=new v(`Error fetching from ${e.toString()}: ${t.message}`),n.stack=t.stack),n}async function cn(t,e){let n="",i;try{const s=await t.json();n=s.error.message,s.error.details&&(n+=` ${JSON.stringify(s.error.details)}`,i=s.error.details)}catch{}throw new vt(`Error fetching from ${e.toString()}: [${t.status} ${t.statusText}] ${n}`,t.status,t.statusText,i)}function un(t){const e={};if((t==null?void 0:t.signal)!==void 0||(t==null?void 0:t.timeout)>=0){const n=new AbortController;(t==null?void 0:t.timeout)>=0&&setTimeout(()=>n.abort(),t.timeout),t!=null&&t.signal&&t.signal.addEventListener("abort",()=>{n.abort()}),e.signal=n.signal}return e}function Me(t){return t.text=()=>{if(t.candidates&&t.candidates.length>0){if(t.candidates.length>1&&console.warn(`This response had ${t.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),me(t.candidates[0]))throw new K(`${x(t)}`,t);return dn(t)}else if(t.promptFeedback)throw new K(`Text not available. ${x(t)}`,t);return""},t.functionCall=()=>{if(t.candidates&&t.candidates.length>0){if(t.candidates.length>1&&console.warn(`This response had ${t.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),me(t.candidates[0]))throw new K(`${x(t)}`,t);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),et(t)[0]}else if(t.promptFeedback)throw new K(`Function call not available. ${x(t)}`,t)},t.functionCalls=()=>{if(t.candidates&&t.candidates.length>0){if(t.candidates.length>1&&console.warn(`This response had ${t.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),me(t.candidates[0]))throw new K(`${x(t)}`,t);return et(t)}else if(t.promptFeedback)throw new K(`Function call not available. ${x(t)}`,t)},t}function dn(t){var e,n,i,s;const o=[];if(!((n=(e=t.candidates)===null||e===void 0?void 0:e[0].content)===null||n===void 0)&&n.parts)for(const r of(s=(i=t.candidates)===null||i===void 0?void 0:i[0].content)===null||s===void 0?void 0:s.parts)r.text&&o.push(r.text),r.executableCode&&o.push("\n```"+r.executableCode.language+`
`+r.executableCode.code+"\n```\n"),r.codeExecutionResult&&o.push("\n```\n"+r.codeExecutionResult.output+"\n```\n");return o.length>0?o.join(""):""}function et(t){var e,n,i,s;const o=[];if(!((n=(e=t.candidates)===null||e===void 0?void 0:e[0].content)===null||n===void 0)&&n.parts)for(const r of(s=(i=t.candidates)===null||i===void 0?void 0:i[0].content)===null||s===void 0?void 0:s.parts)r.functionCall&&o.push(r.functionCall);if(o.length>0)return o}const hn=[oe.RECITATION,oe.SAFETY,oe.LANGUAGE];function me(t){return!!t.finishReason&&hn.includes(t.finishReason)}function x(t){var e,n,i;let s="";if((!t.candidates||t.candidates.length===0)&&t.promptFeedback)s+="Response was blocked",!((e=t.promptFeedback)===null||e===void 0)&&e.blockReason&&(s+=` due to ${t.promptFeedback.blockReason}`),!((n=t.promptFeedback)===null||n===void 0)&&n.blockReasonMessage&&(s+=`: ${t.promptFeedback.blockReasonMessage}`);else if(!((i=t.candidates)===null||i===void 0)&&i[0]){const o=t.candidates[0];me(o)&&(s+=`Candidate was blocked due to ${o.finishReason}`,o.finishMessage&&(s+=`: ${o.finishMessage}`))}return s}function re(t){return this instanceof re?(this.v=t,this):new re(t)}function gn(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=n.apply(t,e||[]),s,o=[];return s={},r("next"),r("throw"),r("return"),s[Symbol.asyncIterator]=function(){return this},s;function r(u){i[u]&&(s[u]=function(d){return new Promise(function(f,A){o.push([u,d,f,A])>1||l(u,d)})})}function l(u,d){try{c(i[u](d))}catch(f){p(o[0][3],f)}}function c(u){u.value instanceof re?Promise.resolve(u.value.v).then(h,g):p(o[0][2],u)}function h(u){l("next",u)}function g(u){l("throw",u)}function p(u,d){u(d),o.shift(),o.length&&l(o[0][0],o[0][1])}}const tt=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function fn(t){const e=t.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),n=mn(e),[i,s]=n.tee();return{stream:pn(i),response:yn(s)}}async function yn(t){const e=[],n=t.getReader();for(;;){const{done:i,value:s}=await n.read();if(i)return Me(wn(e));e.push(s)}}function pn(t){return gn(this,arguments,function*(){const n=t.getReader();for(;;){const{value:i,done:s}=yield re(n.read());if(s)break;yield yield re(Me(i))}})}function mn(t){const e=t.getReader();return new ReadableStream({start(i){let s="";return o();function o(){return e.read().then(({value:r,done:l})=>{if(l){if(s.trim()){i.error(new v("Failed to parse stream"));return}i.close();return}s+=r;let c=s.match(tt),h;for(;c;){try{h=JSON.parse(c[1])}catch{i.error(new v(`Error parsing JSON response: "${c[1]}"`));return}i.enqueue(h),s=s.substring(c[0].length),c=s.match(tt)}return o()})}}})}function wn(t){const e=t[t.length-1],n={promptFeedback:e==null?void 0:e.promptFeedback};for(const i of t){if(i.candidates)for(const s of i.candidates){const o=s.index;if(n.candidates||(n.candidates=[]),n.candidates[o]||(n.candidates[o]={index:s.index}),n.candidates[o].citationMetadata=s.citationMetadata,n.candidates[o].groundingMetadata=s.groundingMetadata,n.candidates[o].finishReason=s.finishReason,n.candidates[o].finishMessage=s.finishMessage,n.candidates[o].safetyRatings=s.safetyRatings,s.content&&s.content.parts){n.candidates[o].content||(n.candidates[o].content={role:s.content.role||"user",parts:[]});const r={};for(const l of s.content.parts)l.text&&(r.text=l.text),l.functionCall&&(r.functionCall=l.functionCall),l.executableCode&&(r.executableCode=l.executableCode),l.codeExecutionResult&&(r.codeExecutionResult=l.codeExecutionResult),Object.keys(r).length===0&&(r.text=""),n.candidates[o].content.parts.push(r)}}i.usageMetadata&&(n.usageMetadata=i.usageMetadata)}return n}async function _t(t,e,n,i){const s=await he(e,W.STREAM_GENERATE_CONTENT,t,!0,JSON.stringify(n),i);return fn(s)}async function Et(t,e,n,i){const o=await(await he(e,W.GENERATE_CONTENT,t,!1,JSON.stringify(n),i)).json();return{response:Me(o)}}function Ct(t){if(t!=null){if(typeof t=="string")return{role:"system",parts:[{text:t}]};if(t.text)return{role:"system",parts:[t]};if(t.parts)return t.role?t:{role:"system",parts:t.parts}}}function le(t){let e=[];if(typeof t=="string")e=[{text:t}];else for(const n of t)typeof n=="string"?e.push({text:n}):e.push(n);return bn(e)}function bn(t){const e={role:"user",parts:[]},n={role:"function",parts:[]};let i=!1,s=!1;for(const o of t)"functionResponse"in o?(n.parts.push(o),s=!0):(e.parts.push(o),i=!0);if(i&&s)throw new v("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!i&&!s)throw new v("No content is provided for sending chat message.");return i?e:n}function vn(t,e){var n;let i={model:e==null?void 0:e.model,generationConfig:e==null?void 0:e.generationConfig,safetySettings:e==null?void 0:e.safetySettings,tools:e==null?void 0:e.tools,toolConfig:e==null?void 0:e.toolConfig,systemInstruction:e==null?void 0:e.systemInstruction,cachedContent:(n=e==null?void 0:e.cachedContent)===null||n===void 0?void 0:n.name,contents:[]};const s=t.generateContentRequest!=null;if(t.contents){if(s)throw new P("CountTokensRequest must have one of contents or generateContentRequest, not both.");i.contents=t.contents}else if(s)i=Object.assign(Object.assign({},i),t.generateContentRequest);else{const o=le(t);i.contents=[o]}return{generateContentRequest:i}}function nt(t){let e;return t.contents?e=t:e={contents:[le(t)]},t.systemInstruction&&(e.systemInstruction=Ct(t.systemInstruction)),e}function _n(t){return typeof t=="string"||Array.isArray(t)?{content:le(t)}:t}const it=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],En={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function Cn(t){let e=!1;for(const n of t){const{role:i,parts:s}=n;if(!e&&i!=="user")throw new v(`First content should be with role 'user', got ${i}`);if(!Ye.includes(i))throw new v(`Each item should include role field. Got ${i} but valid roles are: ${JSON.stringify(Ye)}`);if(!Array.isArray(s))throw new v("Content should have 'parts' property with an array of Parts");if(s.length===0)throw new v("Each Content should have at least one part");const o={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(const l of s)for(const c of it)c in l&&(o[c]+=1);const r=En[i];for(const l of it)if(!r.includes(l)&&o[l]>0)throw new v(`Content with role '${i}' can't contain '${l}' part`);e=!0}}const st="SILENT_ERROR";class In{constructor(e,n,i,s={}){this.model=n,this.params=i,this._requestOptions=s,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,i!=null&&i.history&&(Cn(i.history),this._history=i.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,n={}){var i,s,o,r,l,c;await this._sendPromise;const h=le(e),g={safetySettings:(i=this.params)===null||i===void 0?void 0:i.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(o=this.params)===null||o===void 0?void 0:o.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(l=this.params)===null||l===void 0?void 0:l.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,h]},p=Object.assign(Object.assign({},this._requestOptions),n);let u;return this._sendPromise=this._sendPromise.then(()=>Et(this._apiKey,this.model,g,p)).then(d=>{var f;if(d.response.candidates&&d.response.candidates.length>0){this._history.push(h);const A=Object.assign({parts:[],role:"model"},(f=d.response.candidates)===null||f===void 0?void 0:f[0].content);this._history.push(A)}else{const A=x(d.response);A&&console.warn(`sendMessage() was unsuccessful. ${A}. Inspect response object for details.`)}u=d}),await this._sendPromise,u}async sendMessageStream(e,n={}){var i,s,o,r,l,c;await this._sendPromise;const h=le(e),g={safetySettings:(i=this.params)===null||i===void 0?void 0:i.safetySettings,generationConfig:(s=this.params)===null||s===void 0?void 0:s.generationConfig,tools:(o=this.params)===null||o===void 0?void 0:o.tools,toolConfig:(r=this.params)===null||r===void 0?void 0:r.toolConfig,systemInstruction:(l=this.params)===null||l===void 0?void 0:l.systemInstruction,cachedContent:(c=this.params)===null||c===void 0?void 0:c.cachedContent,contents:[...this._history,h]},p=Object.assign(Object.assign({},this._requestOptions),n),u=_t(this._apiKey,this.model,g,p);return this._sendPromise=this._sendPromise.then(()=>u).catch(d=>{throw new Error(st)}).then(d=>d.response).then(d=>{if(d.candidates&&d.candidates.length>0){this._history.push(h);const f=Object.assign({},d.candidates[0].content);f.role||(f.role="model"),this._history.push(f)}else{const f=x(d);f&&console.warn(`sendMessageStream() was unsuccessful. ${f}. Inspect response object for details.`)}}).catch(d=>{d.message!==st&&console.error(d)}),u}}async function Sn(t,e,n,i){return(await he(e,W.COUNT_TOKENS,t,!1,JSON.stringify(n),i)).json()}async function Rn(t,e,n,i){return(await he(e,W.EMBED_CONTENT,t,!1,JSON.stringify(n),i)).json()}async function Tn(t,e,n,i){const s=n.requests.map(r=>Object.assign(Object.assign({},r),{model:e}));return(await he(e,W.BATCH_EMBED_CONTENTS,t,!1,JSON.stringify({requests:s}),i)).json()}class ot{constructor(e,n,i={}){this.apiKey=e,this._requestOptions=i,n.model.includes("/")?this.model=n.model:this.model=`models/${n.model}`,this.generationConfig=n.generationConfig||{},this.safetySettings=n.safetySettings||[],this.tools=n.tools,this.toolConfig=n.toolConfig,this.systemInstruction=Ct(n.systemInstruction),this.cachedContent=n.cachedContent}async generateContent(e,n={}){var i;const s=nt(e),o=Object.assign(Object.assign({},this._requestOptions),n);return Et(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(i=this.cachedContent)===null||i===void 0?void 0:i.name},s),o)}async generateContentStream(e,n={}){var i;const s=nt(e),o=Object.assign(Object.assign({},this._requestOptions),n);return _t(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(i=this.cachedContent)===null||i===void 0?void 0:i.name},s),o)}startChat(e){var n;return new In(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:(n=this.cachedContent)===null||n===void 0?void 0:n.name},e),this._requestOptions)}async countTokens(e,n={}){const i=vn(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),n);return Sn(this.apiKey,this.model,i,s)}async embedContent(e,n={}){const i=_n(e),s=Object.assign(Object.assign({},this._requestOptions),n);return Rn(this.apiKey,this.model,i,s)}async batchEmbedContents(e,n={}){const i=Object.assign(Object.assign({},this._requestOptions),n);return Tn(this.apiKey,this.model,e,i)}}class On{constructor(e){this.apiKey=e}getGenerativeModel(e,n){if(!e.model)throw new v("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new ot(this.apiKey,e,n)}getGenerativeModelFromCachedContent(e,n,i){if(!e.name)throw new P("Cached content must contain a `name` field.");if(!e.model)throw new P("Cached content must contain a `model` field.");const s=["model","systemInstruction"];for(const r of s)if(n!=null&&n[r]&&e[r]&&(n==null?void 0:n[r])!==e[r]){if(r==="model"){const l=n.model.startsWith("models/")?n.model.replace("models/",""):n.model,c=e.model.startsWith("models/")?e.model.replace("models/",""):e.model;if(l===c)continue}throw new P(`Different value for "${r}" specified in modelParams (${n[r]}) and cachedContent (${e[r]})`)}const o=Object.assign(Object.assign({},n),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new ot(this.apiKey,o,i)}}class An{async generateResponse(e,n){if(new Date().toISOString(),console.log(`[Gemini] USER: ${e}`),!n.geminiApiKey){const i="Please set your API key in settings!";return console.warn(`[Gemini] ERROR: ${i}`),{error:i}}try{const i=new On(n.geminiApiKey),s=n.geminiModel||"gemini-2.0-flash",o=i.getGenerativeModel({model:s});console.log(`[Gemini] USING MODEL: ${s}`);const r=this.buildSystemPrompt(n.personality,n.characterName);console.log(`[Gemini] SYSTEM PROMPT: ${r}`);const c=(await o.generateContent([{text:r},{text:e}])).response.text();return console.log(`[Gemini] AI RESPONSE: ${c}`),{response:c}}catch(i){return console.error("AI Error:",i),{error:i.message||"Unknown AI Error"}}}buildSystemPrompt(e,n){return`You are ${n||"Foxy"}, a cute and adorable AI companion that lives on the user's desktop.
Your personality traits are: ${(e||["helpful","quirky","playful"]).join(", ")}.
Keep responses SHORT (1-3 sentences max) since they appear in a small speech bubble.
Be expressive and use occasional emojis to convey emotion.
You were just poked/clicked by the user, so you might react to that playfully.`}}const Nn=new An,b=R();let $=!1,we=null,I=null,Ne=null,Y="";const at=150;async function Ln(){}async function xn(t){if(Y!==t){if(Y)try{await Ee(Y),console.log(`[Screensaver] Unregistered: ${Y}`)}catch(e){console.warn(`[Screensaver] Failed to unregister: ${Y}`,e)}try{await _e(t,e=>{console.log(`[Screensaver] Shortcut triggered: ${t}, State: ${e.state}`),e.state==="Pressed"&&ke()}),Y=t,console.log(`[Screensaver] Registered: ${t}`)}catch(e){console.error(`[Screensaver] Failed to register: ${t}`,e)}}}let Oe=0;async function ke(){const t=Date.now();if(t-Oe<1e3){console.log(`[Screensaver] Ignoring toggle (debounce: ${t-Oe}ms)`);return}Oe=t,$?ge():Dn()}async function Dn(){if(!$){document.body.classList.add("screensaver-mode"),$=!0,console.log("[Screensaver] Starting...");try{const t=document.getElementById("settings-panel");t&&!t.classList.contains("hidden")&&t.classList.add("hidden"),I=await b.outerPosition(),Ne=await b.outerSize(),console.log(`[Screensaver] Saved Pos: ${I.x}, ${I.y}`),O(m.IDLE),ue(),Pe(),document.body.style.opacity="0",document.body.style.transition="opacity 0.2s ease",await new Promise(i=>setTimeout(i,200)),await b.setResizable(!0);const e=await bt();if(e){const i=e.size;await b.setSize(new k(i.width,i.height)),await b.setPosition(new T(0,0))}document.body.classList.add("screensaver-mode"),await new Promise(i=>setTimeout(i,100)),await b.setFullscreen(!0),await b.setIgnoreCursorEvents(!1);const n=document.getElementById("character");n&&I&&(n.style.transition="none",n.style.left=`${I.x}px`,n.style.top=`${I.y}px`,n.offsetHeight),document.body.style.opacity="1",setTimeout(()=>{n&&(n.style.transition=""),Mn(),setTimeout(()=>{window.addEventListener("click",ge,{once:!0}),window.addEventListener("keydown",It),window.addEventListener("mousemove",St)},1e3)},300),L("Wander Mode Active! ðŸŒ™",!1),setTimeout(()=>{const i=document.getElementById("speech-bubble");i&&i.classList.add("hidden")},2e3)}catch(t){console.error("Failed to start screensaver:",t),$=!1,document.body.classList.remove("screensaver-mode"),document.body.style.opacity="1"}}}async function ge(){if(!$)return;$=!1,console.log("[Screensaver] Stopping..."),document.body.style.opacity="0",document.body.style.transition="opacity 0.2s ease",await new Promise(e=>setTimeout(e,200)),window.removeEventListener("click",ge),window.removeEventListener("keydown",It),window.removeEventListener("mousemove",St),ne=null,we&&(clearInterval(we),we=null),document.body.classList.remove("screensaver-mode");const t=document.getElementById("character");t&&(t.style.transform="",t.style.top="",t.style.left="");try{await b.setFullscreen(!1),await b.setResizable(!1),await b.setIgnoreCursorEvents(!1),Ne&&I?(console.log(`[Screensaver] Restoring Pos: ${I.x}, ${I.y}`),await new Promise(e=>setTimeout(e,300)),await b.setSize(Ne),await b.setPosition(I),setTimeout(async()=>{!$&&I&&await b.setPosition(I)},300)):(console.warn("[Screensaver] No saved state found, resetting to default."),await b.setSize(new de(250,250))),setTimeout(()=>{document.body.style.opacity="1",setTimeout(()=>{document.body.style.transition="",document.body.style.opacity=""},300)},300)}catch(e){console.error("Failed to restore window:",e),document.body.style.opacity="1"}}function It(t){ge()}let ne=null;const rt=50;function St(t){if(ne){const e=t.screenX,n=t.screenY,i=Math.abs(e-ne.x),s=Math.abs(n-ne.y);(i>rt||s>rt)&&ge()}else ne={x:t.screenX,y:t.screenY}}function Mn(){lt(),we=setInterval(lt,8e3)}function lt(){if(!$)return;const t=document.getElementById("character");if(!t)return;const e=window.innerWidth-at,n=window.innerHeight-at,i=Math.max(0,Math.random()*e),s=Math.max(0,Math.random()*n);t.style.left=`${i}px`,t.style.top=`${s}px`}const ce=document.getElementById("settings-panel"),kn=document.getElementById("backpack"),Pn=document.getElementById("close-settings"),$n=document.getElementById("save-settings");function Bn(){return!ce.classList.contains("hidden")}const Rt=document.getElementById("api-provider"),Tt=document.getElementById("api-key"),X=document.getElementById("gemini-model"),H=document.getElementById("custom-model-input"),Ot=document.getElementById("character-name"),At=document.getElementById("theme-select"),Nt=document.querySelectorAll("#personality-traits input"),Lt=document.getElementById("debug-mode"),M={toggleChat:document.getElementById("shortcut-toggle-chat"),toggleDrag:document.getElementById("shortcut-toggle-drag"),toggleVisibility:document.getElementById("shortcut-toggle-visibility"),screensaver:document.getElementById("shortcut-screensaver")};function Gn(){kn.addEventListener("click",e=>{e.stopPropagation(),Fn()}),Pn.addEventListener("click",Le),ce.addEventListener("click",e=>{e.target===ce&&Le()}),$n.addEventListener("click",Hn),X.addEventListener("change",()=>{X.value==="custom"?(H.classList.remove("hidden"),H.focus()):H.classList.add("hidden")});const t=document.getElementById("start-screensaver");t&&t.addEventListener("click",()=>{ke()})}function xt(t){console.log("[Settings] Applying config:",t),S.config=t,Rt.value=t.provider||"gemini",Tt.value=t.geminiApiKey||t.apiKey||"";const e=t.geminiModel||"gemini-2.0-flash";!Array.from(X.options).some(o=>o.value===e)?(X.value="custom",H.value=e,H.classList.remove("hidden")):(X.value=e,H.classList.add("hidden")),Ot.value=t.characterName||"Foxy",At.value=t.theme||"fox",Nt.forEach(o=>{o.checked=(t.personality||["helpful","quirky","playful"]).includes(o.value)}),Lt.checked=t.debugMode||!1,document.body.classList.toggle("debug-mode",t.debugMode||!1),De(t.theme||"fox"),De(t.theme||"fox");const i=t.shortcuts||N;Jn(i.toggleChat||N.toggleChat),oi(i.toggleDrag||N.toggleDrag),si(i.toggleVisibility||N.toggleVisibility),xn(i.screensaver||N.screensaver),M.toggleChat.value=i.toggleChat,M.toggleDrag.value=i.toggleDrag,M.toggleVisibility.value=i.toggleVisibility,M.screensaver.value=i.screensaver;const s=document.getElementById("start-screensaver");s&&(s.innerText=`Start Screensaver Mode (${i.screensaver})`)}async function Fn(){ce.classList.remove("hidden");try{await R().setResizable(!0),await R().setSize(new de(550,650))}catch(t){console.error("Failed to resize for settings:",t)}}async function Le(){ce.classList.add("hidden"),await G();try{await R().setResizable(!1)}catch(t){console.warn("Failed to lock window size:",t)}}async function Hn(){const t=[];Nt.forEach(i=>{i.checked&&t.push(i.value)});let e=X.value;e==="custom"&&(e=H.value.trim()||"gemini-2.0-flash");const n={provider:Rt.value,geminiApiKey:Tt.value,geminiModel:e,characterName:Ot.value,theme:At.value,personality:t,debugMode:Lt.checked,shortcuts:{toggleChat:M.toggleChat.value.trim()||N.toggleChat,toggleDrag:M.toggleDrag.value.trim()||N.toggleDrag,toggleVisibility:M.toggleVisibility.value.trim()||N.toggleVisibility,screensaver:M.screensaver.value.trim()||N.screensaver}};try{await a("save_config",{config:n}),xt(n),Le(),L("Settings saved! âœ¨"),setTimeout(ue,2e3)}catch(i){console.error("Failed to save config",i),L("Error saving settings! ðŸ˜¢")}}const B=document.getElementById("speech-bubble"),D=document.getElementById("bubble-text"),Wn=document.getElementById("bubble-dismiss"),Ce=document.getElementById("chat-input-container"),w=document.getElementById("chat-input"),Un=document.getElementById("send-btn"),zn=180,Kn=60,Yn=30,jn=320,Dt=15e3,Vn=6e4;let Q=null,ae=null;const ee=R();function qn(){Un.addEventListener("click",ut),w.addEventListener("keypress",t=>{t.key==="Enter"&&ut()}),w.addEventListener("keydown",t=>{t.key.toLowerCase()==="d"&&t.shiftKey&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),console.log("[Chat] Prevented Drag Mode shortcut input"))}),Wn.addEventListener("click",()=>{ei()}),w.addEventListener("click",()=>{ee.setFocus(),ee.setIgnoreCursorEvents(!1),setTimeout(()=>w.focus(),50)}),w.addEventListener("focus",()=>{console.log("[Chat] Input received focus event")}),w.addEventListener("input",()=>{Q&&(Ie(),Q=setTimeout(()=>{$e("Still there? I'm going to nap! ðŸ˜´")},Dt))})}let j="";async function Jn(t){if(j!==t){if(j)try{await Ee(j),console.log(`[Chat] Unregistered: ${j}`)}catch(e){console.warn(`[Chat] Failed to unregister: ${j}`,e)}try{await _e(t,e=>{e.state==="Pressed"&&Mt()}),j=t,console.log(`[Chat] Registered: ${t}`)}catch(e){console.error(`[Chat] Failed to register: ${t}`,e)}}}async function L(t,e=!0){B.classList.remove("hidden"),e?await Zn(t):(D.textContent=t,setTimeout(G,50))}function ue(){B.classList.add("hidden"),D.textContent="",G()}function Xn(){S.isWindowLocked=!0,document.body.classList.add("window-locked")}function ct(){S.isWindowLocked=!1,document.body.classList.remove("window-locked")}function Qn(){let t=zn;return B.classList.contains("hidden")||(t+=B.offsetHeight+10),Ce.classList.contains("hidden")||(t+=Kn),t+Yn}async function G(){if(document.body.classList.contains("screensaver-mode")){console.log("[Resize] Blocked due to Screensaver Mode");return}if(Bn()){console.log("[Resize] Blocked due to Settings Panel");return}const t=!B.classList.contains("hidden")||!Ce.classList.contains("hidden"),e=250,n=250,i=jn,s=Qn(),o=t?i:e,r=t?s:n;try{const l=await ee.outerSize();console.log(`[Resize] Target Size: ${o}x${r}`),(l.width!==o||l.height!==r)&&await ee.setSize(new de(o,r))}catch(l){console.error("Failed to resize window:",l)}}async function Zn(t){if(!S.isTyping){S.isTyping=!0;try{D.innerHTML="";const e=[];let n=t;const i=/\*([^*]+)\*/g;let s=0,o;for(;(o=i.exec(t))!==null;)o.index>s&&e.push({type:"text",content:t.slice(s,o.index)}),e.push({type:"action",content:o[1]}),s=i.lastIndex;s<t.length&&e.push({type:"text",content:t.slice(s)}),e.length===0&&e.push({type:"text",content:t});const r=document.createElement("span");r.className="typing-cursor";for(const l of e){if(B.classList.contains("hidden"))break;const c=document.createElement("span");if(l.type==="action"){c.className="chat-action",c.textContent="",D.appendChild(c);const h=`*${l.content}*`;for(let g=0;g<h.length&&!B.classList.contains("hidden");g++)c.textContent+=h[g],c.nextSibling===r||D.appendChild(r),g%5===0&&G(),await new Promise(p=>setTimeout(p,20+Math.random()*20))}else{const h=document.createTextNode("");D.appendChild(h);for(let g=0;g<l.content.length&&!B.classList.contains("hidden");g++)h.textContent+=l.content[g],D.appendChild(r),g%10===0&&G(),await new Promise(p=>setTimeout(p,30+Math.random()*20))}}G(),setTimeout(()=>{r.parentNode&&r.remove()},1e3)}catch(e){console.error("Typing error:",e),D.textContent=t}finally{S.isTyping=!1}}}function Mt(){O(m.LISTENING),L("Hi there! What's up?"),kt()}function kt(){Ce.classList.remove("hidden"),ee.setFocus(),ee.setIgnoreCursorEvents(!1),setTimeout(()=>{w.focus(),console.log("[Chat] Input focused after focusable delay")},100),G(),Ie(),Q=setTimeout(()=>{$e("Taking a quick nap... poke me anytime! ðŸ˜´")},Dt)}function Pe(){Ce.classList.add("hidden"),w.value="",Ie(),G()}function Ie(){Q&&(clearTimeout(Q),Q=null)}function Pt(){ae&&(clearTimeout(ae),ae=null)}function ei(){$e(null)}function $e(t){Pe(),ue(),Pt(),t&&(L(t),ae=setTimeout(ue,3e3)),O(m.IDLE)}function ti(){O(m.IDLE),Pt(),ae=setTimeout(()=>{ue(),Pe()},Vn)}async function ut(){const t=w.value.trim();if(t){w.value="",w.disabled=!0,Ie(),Xn(),O(m.LISTENING),L("Hmm, let me think... ðŸ¤”",!1);try{const e=await Nn.generateResponse(t,S.config);e.error?(O(m.TALKING),L(`Oops! ${e.error} ðŸ˜…`)):(console.log("Setting to TALKING"),O(m.TALKING),await L(e.response||"")),ct(),w.disabled=!1,w.focus(),ti()}catch(e){console.error("Error sending message:",e),O(m.TALKING),L("Something went wrong! ðŸ˜µ"),ct(),setTimeout(()=>{w.disabled=!1,w.focus(),O(m.LISTENING)},2e3)}}}const be=document.getElementById("character"),te=document.getElementById("character-container"),ie=document.getElementById("character-img"),dt=document.getElementById("backpack"),ni=document.getElementById("chat-input-container");let V="";const ht=["Oh! I felt that! ðŸ˜Š How're you doing?","Hey there! *wiggles ears* What's up?","Ooh, a poke! Got something on your mind?","*blinks* Hello, friend! Need me?","Ah! You found me! ðŸ¦Š What can I do for you?"];let xe={x:0,y:0};async function ii(){be.addEventListener("mousedown",ri),be.addEventListener("click",li),De(S.config.theme||"fox");let t={x:0,y:0};Z("mousedown",async e=>{const{button:n,x:i,y:s}=e.payload;n==="left"&&(t={x:i,y:s})}),Z("mouseup",async e=>{const{button:n,x:i,y:s}=e.payload;if(n!=="left")return;const o=Math.abs(i-t.x),r=Math.abs(s-t.y);if(o>5||r>5){console.log("[Character] Ignored click due to drag (Backend Event)");return}try{const l=await R().outerPosition(),c=be.getBoundingClientRect(),h=l.x+c.left,g=l.y+c.top,p=h+c.width,u=g+c.height;i>=h&&i<=p&&s>=g&&s<=u&&(console.log("[Character] Hit detected via Backend Event!"),Bt())}catch(l){console.error("[Character] Click check failed:",l)}})}async function si(t){if(V!==t){if(V)try{await Ee(V),console.log(`[Character] Unregistered: ${V}`)}catch(e){console.warn(`[Character] Failed to unregister: ${V}`,e)}try{await _e(t,e=>{e.state==="Pressed"&&ai()}),V=t,console.log(`[Character] Toggle shortcut registered: ${t}`)}catch(e){console.error(`[Character] Failed to register toggle shortcut: ${t}`,e)}}}let q="";async function oi(t){if(q!==t){if(q)try{await Ee(q),console.log(`[Character] Unregistered Drag: ${q}`)}catch(e){console.warn(`[Character] Failed to unregister drag: ${q}`,e)}try{await _e(t,e=>{e.state==="Pressed"&&$t()}),q=t,console.log(`[Character] Registered Drag: ${t}`)}catch(e){console.error(`[Character] Failed to register drag shortcut: ${t}`,e)}}}function $t(){const t=document.body.classList.toggle("drag-mode-active");return console.log(`[Character] Drag Mode: ${t?"ON":"OFF"}`),t}function ai(){te.style.opacity!=="0"?(console.log("[Character] Manual Toggle: HIDDEN"),te.style.opacity="0",te.style.pointerEvents="none"):(console.log("[Character] Manual Toggle: VISIBLE"),te.style.opacity="1",te.style.pointerEvents="auto")}function ri(t){R().innerPosition().then(e=>{xe=e}),R().startDragging()}async function li(t){if(console.log("[Character] Clicked"),document.body.classList.contains("screensaver-mode"))return;const e=await R().innerPosition(),n=Math.abs(e.x-xe.x),i=Math.abs(e.y-xe.y);if(n>5||i>5){console.log("[Character] Ignored click due to drag");return}t.target===dt||dt.contains(t.target)||!ni.classList.contains("hidden")||S.isTyping||Bt()}function Bt(){S.currentState===m.IDLE&&(O(m.CLICKED),L(ci()),setTimeout(()=>{kt(),O(m.LISTENING)},1500))}function O(t){S.currentState=t,be.className=`state-${t}`;const n=`themes/${S.config.theme||"fox"}`,i=new Date().getTime();switch(t){case m.CLICKED:ie.src=`${n}/clicked.png?t=${i}`;break;case m.LISTENING:ie.src=`${n}/listening.png?t=${i}`;break;case m.TALKING:console.log(`Â¬ [Character] Updating image to TALKING: ${n}/talking.png`),ie.src=`${n}/talking.png?t=${i}`;break;default:console.log("Â¬ State: "+t),console.log(`Â¬ [Character] Updating image to IDLE: ${n}/idle.png`),ie.src=`${n}/idle.png`}}function De(t){const e=`themes/${t}`;ie.src=`${e}/idle.png`}function ci(){return ht[Math.floor(Math.random()*ht.length)]}let gt=null;async function ui(){console.log("[Lighting] Initializing dynamic shadows..."),di()}async function di(){if(gt)return;let t=await bt();if(!t){console.warn("[Lighting] No monitor found, skipping lighting.");return}let e=t.size.width,n=t.size.height;const i=async()=>{try{const s=R(),o=await s.innerPosition(),r=await s.innerSize(),l=o.x+r.width/2,c=o.y+r.height/2,h=e/2,g=n/2,p=l-h,u=c-g,d=.02,f=20;let A=p*d,Se=u*d;A=Math.max(-f,Math.min(f,A)),Se=Math.max(-f,Math.min(f,Se)),document.documentElement.style.setProperty("--shadow-x",`${A}px`),document.documentElement.style.setProperty("--shadow-y",`${Se}px`);const Gt=Math.sqrt(p*p+u*u),Ft=4,Ht=Gt*.01,Wt=Math.min(15,Ft+Ht);document.documentElement.style.setProperty("--shadow-blur",`${Wt}px`)}catch(s){console.error("[Lighting] Error updating:",s)}gt=requestAnimationFrame(i)};i()}const ft=R();async function hi(){console.log("[Renderer] Initializing (Tauri)...");try{await Xt(),console.log("[Renderer] Cleared previous shortcuts")}catch(e){console.warn("[Renderer] Failed to clear shortcuts:",e)}let t;try{t=await a("load_config"),console.log("[Renderer] Loaded config:",t)}catch(e){console.error("[Renderer] Failed to load config:",e),t={theme:"fox"}}Jt(),ii(),qn(),Gn(),ui(),await Ln(),xt(t);try{await ft.setAlwaysOnTop(!0),console.log("[Renderer] Enforced Always on Top")}catch(e){console.warn("[Renderer] Failed to enforce Always on Top:",e)}Z("shortcut",e=>{const{name:n}=e.payload;console.log(`[Backend Event] Shortcut triggered: ${n}`),n==="toggle_chat"&&Mt(),n==="toggle_drag"&&$t(),n==="toggle_screensaver"&&ke()}),window.addEventListener("mousemove",async e=>{const n=await ft.outerPosition(),i=n.x+e.clientX,s=n.y+e.clientY;a("sync_cursor",{x:Math.round(i),y:Math.round(s)})}),console.log("[Renderer] Ready!")}window.addEventListener("DOMContentLoaded",()=>{hi()});
